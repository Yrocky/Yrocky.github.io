<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><title>Yrocky's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Yrocky</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">Realm数据库</h1><div class="post-info">12月 28日 2015</div><div class="post-entry"><img src="/2015/12/28/realm/realm.png" alt="Realm" title="Realm">
<p>在以前的项目中数据库是使用的FMDB，数据字段在工程中是用OC对象进行引用的，如果要添加字段需要在数据库、OC对象两个地方添加，不是很方便，既然数据是以OC对象展示的，那为何不能通过修改OC对象达到修改数据库字段的目的呢？由于见识有限，当时也没有细想如何达到这样的目的，在时隔一年之后在看了Realm，发现他就是用这样的方式进行数据库操作的，而且看了他的API，还是比较简单的，顺带手的就学习了，现记录如下。</p>
<a id="more"></a>
<h2 id="一、Realm数据库的获取">一、<a href="https://realm.io/cn/" target="_blank" rel="external">Realm数据库</a>的获取</h2><p>realm提供了三种创建数据库的方法，如下所示</p>
<h3 id="1-_使用默认的数据库">1. 使用默认的数据库</h3><p>realm为使用者提供了一个默认的数据库，defaultRealm。通过调用 [RLMRealm defaultRealm] 来初始化以及访问我们的 realm 变量。</p>
<h3 id="2-自己定义数据库">2.自己定义数据库</h3><h4 id="2-1使用RLMRealmConfiguration提供的弄人数据库位置并设置数据库的名字、readonly属性等等">2.1使用RLMRealmConfiguration提供的弄人数据库位置并设置数据库的名字、readonly属性等等</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认的目录，但是使用用户名来替换默认的文件名</span></span><br><span class="line">config.path = [[[config.path stringByDeletingLastPathComponent]</span><br><span class="line"><span class="string">stringByAppendingPathComponent:</span>yourDataBaseName]</span><br><span class="line"><span class="string">stringByAppendingPathExtension:</span>@<span class="string">"realm"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将这个配置应用到默认的 Realm 数据库当中</span></span><br><span class="line">[RLMRealmConfiguration <span class="string">setDefaultConfiguration:</span>config];</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong>这里在进行配置的时候还有一个可选方法，传递<code>config</code>以及<code>error</code>，你应该一直传入error以捕获由于内存爆掉、设置错误等报错信息的出现</p>
<h4 id="2-2不使用RLMRealmConfiguration提供的path">2.2不使用RLMRealmConfiguration提供的path</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *docPath = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line"><span class="built_in">NSString</span> *dbPath = [docPath stringByAppendingPathComponent:<span class="string">@"db/yourDataBaseName.realm"</span>];</span><br><span class="line">RLMRealm *realm = [RLMRealm realmWithPath:dbPath readOnly:<span class="literal">YES</span> error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h3 id="3-创建一个内存数据库">3.创建一个内存数据库</h3><p>一般的realm数据库是存储在硬盘上的，但有时候也需要在内存中创建一个数据库，可以使用如下方法进行创建。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">RLMRealmConfiguration *config</span> = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line">config.inMemoryIdentifier = @<span class="string">"yourInMemoryDataBase"</span>;</span><br><span class="line"><span class="constant">RLMRealm *realm</span> = [RLMRealm realmWithConfiguration:config];</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"><span class="constant"></span><br><span class="line">RLMRealm *realm</span> = [RLMRealm inMemoryRealmWithIdentifier:@<span class="string">"yourInMemoryDataBase"</span>];<span class="comment">// less is more</span></span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong>内存数据库在每次程序退出时不会保存数据。如果某个内存Realm实例没有被引用，所有的数据在实例对象释放的适合也会被释放。建议你在app中用强引用来钳制所有新建的内存Realm数据库实例。</p>
<h2 id="二、Realm数据库的数据库迁移以及更新">二、Realm数据库的数据库迁移以及更新</h2><p>当数据库版本有改动的时候，在以往的数据库管理方法中是将数据库中的字段进行修改，然后才能进行新版本的数据库的使用。而realm的数据库模型是用OC对来定义的数据库，所以在修改数据库的时候只进行realm对象的修改就能够达到目的，这是很方便的。</p>
<p>现在假设有一个realm模型</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v0.0</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: RLMObject</span><br><span class="line"><span class="variable">@property</span> NSString *firstName;</span><br><span class="line"><span class="variable">@property</span> NSString *lastName;</span><br><span class="line"><span class="variable">@property</span> int age;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>在v0.1版本中由于逻辑的改变，需要将<code>firstName</code>以及<code>lastName</code>合并成一个<code>fullName</code>字段，在模型中我们只需要添加如下一个属性即可，如下</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v0.1</span></span><br><span class="line">   <span class="variable">@interface</span> <span class="attribute">Person </span>: RLMObject</span><br><span class="line">   <span class="variable">@property</span> NSString *fullName;</span><br><span class="line">   <span class="variable">@property</span> int age;</span><br><span class="line">   <span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>如果在v0.2版本中又新增加一个属性<code>email</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v0.2</span></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: RLMObject</span><br><span class="line"><span class="variable">@property</span> NSString *fullName;</span><br><span class="line"><span class="variable">@property</span> NSString *email;   <span class="comment">// 新属性</span></span><br><span class="line"><span class="variable">@property</span> int age;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>但是这时候realm数据库中的字段还是没有修改的，我们要做的是通知数据库，某些字段和某些字段发生了某些变化，如果在这之前你尝试更新之前就保存的数据的话，数据库就会报错，因为数据库中没有<code>fullName</code>字段。这时候就需要使用数据库迁移。</p>
<p>realm提供了RLMRealmConfiguration的<code>schemaVersion</code>NSInteger属性以及<code>migrationBlock</code>block属性定义一个迁移操作以及与之关联的架构版本。 每当通过配置创建完一个 RLMRealm之后，迁移闭包将会在迁移需要的时候，将给定的架构版本应用到更新 RLMRealm 操作中。</p>
<p>ok，下面进行迁移的操作,下面是一个最简单的迁移操作模板</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 [AppDelegate didFinishLaunchingWithOptions:] 中进行配置</span></span><br><span class="line"></span><br><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line"><span class="comment">// 设置新的架构版本。这个版本号必须高于之前所用的版本号（如果您之前从未设置过架构版本，那么这个版本号设置为 0）</span></span><br><span class="line">config.schemaVersion = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置闭包，这个闭包将会在打开低于上面所设置版本号的 Realm 数据库的时候被自动调用</span></span><br><span class="line">config.migrationBlock = ^(RLMMigration *migration, <span class="keyword">uint64_t</span> oldSchemaVersion) &#123;</span><br><span class="line">  <span class="comment">// 目前我们还未进行数据迁移，因此 oldSchemaVersion == 0</span></span><br><span class="line">  <span class="keyword">if</span> (oldSchemaVersion &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 什么都不要做！Realm 会自行检测新增和需要移除的属性，然后自动更新硬盘上的数据库架构</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 告诉 Realm 为默认的 Realm 数据库使用这个新的配置对象</span></span><br><span class="line">[RLMRealmConfiguration setDefaultConfiguration:config];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在我们已经告诉了 Realm 如何处理架构的变化，打开文件之后将会自动执行迁移</span></span><br><span class="line">[RLMRealm defaultRealm];</span><br></pre></td></tr></table></figure>
<p>进行v0.1版本的数据库更新</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 [AppDelegate didFinishLaunchingWithOptions:] 中进行配置</span></span><br><span class="line"></span><br><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line">config.schemaVersion = <span class="number">1</span>;</span><br><span class="line">config.migrationBlock = ^(RLMMigration *migration, <span class="keyword">uint64_t</span> oldSchemaVersion) &#123;</span><br><span class="line">  <span class="comment">// 目前我们还未进行数据迁移，因此 oldSchemaVersion == 0</span></span><br><span class="line">  <span class="keyword">if</span> (oldSchemaVersion &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// enumerateObjects:block: 方法遍历了存储在 Realm 文件中的每一个“Person”对象</span></span><br><span class="line">    [migration enumerateObjects:Person.className</span><br><span class="line">                          block:^(RLMObject *oldObject, RLMObject *newObject) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将名字进行合并，存放在 fullName 域中</span></span><br><span class="line">      newObject[@<span class="string">"fullName"</span>] = [NSString stringWithFormat:@<span class="string">"%@ %@"</span>,</span><br><span class="line">                                         oldObject[@<span class="string">"firstName"</span>],</span><br><span class="line">                                         oldObject[@<span class="string">"lastName"</span>]];</span><br><span class="line">    &#125;];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">[RLMRealmConfiguration setDefaultConfiguration:config];</span><br></pre></td></tr></table></figure>
<p>在0.2版本中的迁移逻辑大概就是这样，记得先设置好<code>schemaVersion</code>为当前版本</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line">config.schemaVersion = <span class="number">2</span>;</span><br><span class="line">config.migrationBlock = ^(RLMMigration *migration, <span class="keyword">uint64_t</span> oldSchemaVersion) &#123;</span><br><span class="line">  <span class="comment">// enumerateObjects:block: 遍历了存储在 Realm 文件中的每一个“Person”对象</span></span><br><span class="line">  [migration enumerateObjects:Person.className</span><br><span class="line">                        block:^(RLMObject *oldObject, RLMObject *newObject) &#123;</span><br><span class="line">    <span class="comment">// 只有当 Realm 数据库的架构版本为 0 的时候，才添加 “fullName” 属性</span></span><br><span class="line">    <span class="keyword">if</span> (oldSchemaVersion &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      newObject[@<span class="string">"fullName"</span>] = [NSString stringWithFormat:@<span class="string">"%@ %@"</span>,</span><br><span class="line">                                oldObject[@<span class="string">"firstName"</span>],</span><br><span class="line">                                oldObject[@<span class="string">"lastName"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只有当 Realm 数据库的架构版本小于0.2的时候，才添加“email”属性</span></span><br><span class="line">    <span class="keyword">if</span> (oldSchemaVersion &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      newObject[@<span class="string">"email"</span>] = @<span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;;</span><br><span class="line">[RLMRealmConfiguration setDefaultConfiguration:config];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在我们已经成功更新了架构版本并且提供了迁移闭包，打开旧有的 Realm 数据库会自动执行此数据迁移，然后成功进行访问</span></span><br><span class="line">[RLMRealm defaultRealm];</span><br></pre></td></tr></table></figure></div><div class="post-tags-box"><a class="tag-link" href="/tags/学习/">学习</a>, <a class="tag-link" href="/tags/数据库/">数据库</a></div></article></div><div class="post-nav"><div class="prev-wrap col-md-6 col-xs-6"><i class="fa fa-angle-double-left"></i><a href="/2016/01/09/douban-movie-spider/" class="prev-post">使用OC写一个定向爬虫</a></div><div class="next-wrap col-md-6 col-xs-6"><a href="/2015/12/25/navigation/" class="next-post">HTML5的视频音频</a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;Yrocky&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a> by SHAW</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>