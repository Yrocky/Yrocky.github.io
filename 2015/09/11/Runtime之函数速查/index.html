<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Yrocky's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Yrocky</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">Runtime之基础知识</h1><div class="post-info">2015 9月 11日</div><div class="post-entry"><p>仅仅是一个速查方法，也算是看了半天头文件翻译出来的东西吧。</p>
<a id="more"></a>
<p>先了解几个关键字</p>
<ul>
<li>class：类</li>
<li>metaClass ：元类</li>
<li>instance： 实例变量</li>
<li>ivars：成员变量</li>
<li>property：属性</li>
<li>method：方法</li>
<li>SEL：选择子</li>
<li>IMP：方法的具体实现</li>
</ul>
<blockquote>
<p>Class-类相关的操作函数</p>
</blockquote>
<p>这方面的操作可以使用NSObject的相关类方法得到相同的结果。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取类名：</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * class_getName ( <span class="keyword">Class</span> cls );</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取类的父类：</span></span><br><span class="line"><span class="keyword">Class</span> class_getSuperclass ( <span class="keyword">Class</span> cls );</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断指定的类是不是一个元类：</span></span><br><span class="line">BOOL class_isMetaClass ( <span class="keyword">Class</span> cls );</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Instance-实例变量的操作函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取实例变量大小：</span></span><br><span class="line"><span class="keyword">size_t</span> class_getInstanceSize ( Class cls );</span><br></pre></td></tr></table></figure>
<p>在objc_class中，所有的成员变量、属性的信息是放在链表ivars中的。ivars是一个数组，数组中每个元素是指向Ivar(变量信息)的指针。</p>
<blockquote>
<p>Ivar-成员变量的操作函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取类中指定名称的成员变量信息：</span></span><br><span class="line"><span class="function">Ivar <span class="title">class_getInstanceVariable</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取类成员变量的信息：</span></span><br><span class="line"><span class="function">Ivar <span class="title">class_getClassVariable</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取整个成员变量列表：</span></span><br><span class="line"><span class="function">Ivar * <span class="title">class_copyIvarList</span> <span class="params">( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount )</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Property-属性相关的函数操作</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取指定的属性：</span></span><br><span class="line"><span class="keyword">objc_property_t</span> class_getProperty ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name );</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取属性列表：</span></span><br><span class="line"><span class="keyword">objc_property_t</span> * class_copyPropertyList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为类添加属性</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_addProperty</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//替换类的属性：</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_replaceProperty</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount )</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Method-方法相关的函数</p>
</blockquote>
<p>方法就是选择子(SEL)和方法实现(IMP)组成的。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加方法</span></span><br><span class="line">BOOL class_addMethod ( <span class="keyword">Class</span> cls, SEL name, IMP imp, <span class="keyword">const</span> char *types );</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取实例方法</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">class_getInstanceMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取类方法</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">class_getClassMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 获取所有方法的数组</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> * <span class="title">class_copyMethodList</span> <span class="params">( <span class="keyword">Class</span> cls, unsigned int *outCount )</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 替代方法的实现</span></span><br><span class="line">IMP class_replaceMethod ( <span class="keyword">Class</span> cls, SEL name, IMP imp, <span class="keyword">const</span> char *types );</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回方法的具体实现</span></span><br><span class="line">IMP class_getMethodImplementation ( <span class="keyword">Class</span> cls, SEL name );</span><br><span class="line">IMP class_getMethodImplementation_stret ( <span class="keyword">Class</span> cls, SEL name );</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 类实例是否响应指定的selector</span></span><br><span class="line">BOOL class_respondsToSelector ( <span class="keyword">Class</span> cls, SEL sel );</span><br></pre></td></tr></table></figure>
<blockquote>
<p>协议的相关操作函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加协议</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_addProtocol</span> <span class="params">( Class cls, Protocol *protocol )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回类是否实现指定的协议</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_conformsToProtocol</span> <span class="params">( Class cls, Protocol *protocol )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回类实现的协议列表</span></span><br><span class="line"><span class="function">Protocol * <span class="title">class_copyProtocolList</span> <span class="params">( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount )</span></span>;</span><br></pre></td></tr></table></figure>
<hr>
<p>runtime的强大之处在于它能在<code>运行时创建类和对象</code>。</p>
<blockquote>
<p>动态创建类</p>
</blockquote>
<p>动态创建类涉及到以下几个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个新类和元类</span></span><br><span class="line"><span class="function">Class <span class="title">objc_allocateClassPair</span> <span class="params">( Class superclass, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">size_t</span> extraBytes )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 销毁一个类及其相关联的类</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_disposeClassPair</span> <span class="params">( Class cls )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 在应用中注册由objc_allocateClassPair创建的类</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_registerClassPair</span> <span class="params">( Class cls )</span></span>;</span><br></pre></td></tr></table></figure>
<p>objc_allocateClassPair函数：如果我们要创建一个根类，则superclass指定为Nil。extraBytes通常指定为0，该参数是分配给类和元类对象尾部的索引ivars的字节数。</p>
<p>为了创建一个新类，我们需要调用objc_allocateClassPair。然后使用诸如class_addMethod，class_addIvar等函数来为新创建的类添加方法、实例变量和属性等。完成这些后，我们需要调用objc_registerClassPair函数来注册类，之后这个新类就可以在程序中使用了。</p>
<p>实例方法和实例变量应该添加到类自身上，而类方法应该添加到类的元类上。</p>
<blockquote>
<p>动态创建对象</p>
</blockquote>
<p>动态创建对象的函数如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建类实例</span></span><br><span class="line"><span class="function">id <span class="title">class_createInstance</span> <span class="params">( Class cls, <span class="keyword">size_t</span> extraBytes )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 在指定位置创建类实例</span></span><br><span class="line"><span class="function">id <span class="title">objc_constructInstance</span> <span class="params">( Class cls, <span class="keyword">void</span> *bytes )</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 销毁类实例</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">objc_destructInstance</span> <span class="params">( id obj )</span></span>;</span><br></pre></td></tr></table></figure>
<p>class_createInstance函数：创建实例时，会在默认的内存区域为类分配内存。extraBytes参数表示分配的额外字节数。这些额外的字节可用于存储在类定义中所定义的实例变量之外的实例变量。该函数在ARC环境下无法使用。</p>
<p>objc_constructInstance函数：在指定的位置(bytes)创建类实例。</p>
<p>objc_destructInstance函数：销毁一个类的实例，但不会释放并移除任何与其相关的引用。</p>
</div></article></div><div class="post-nav"><div class="prev-wrap col-md-6 col-xs-6"><i class="fa fa-angle-double-left"></i><a href="/2015/09/11/Runtime之界面跳转/" class="prev-post">Runtime之界面跳转</a></div><div class="next-wrap col-md-6 col-xs-6"><a href="/2015/09/10/重新开始blog，小白采坑实验/" class="next-post">重新开始Blog</a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;Yrocky&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a> by SHAW</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>