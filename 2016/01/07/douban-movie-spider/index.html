<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Yrocky's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Yrocky</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">使用OC写一个定向爬虫</h1><div class="post-info">2016 1月 7日</div><div class="post-entry"><img src="/2016/01/07/douban-movie-spider/ad.png">
<p>由于最近在学python进行爬虫，目前仅仅处于定向爬取一些网页的图片什么的，但是对于爬取出来的数据我想展示到我的移动端设备上，最好是原生语言OC开发的app上，这也是我学习python的初衷。但这需要自己搭建服务器，好像还需要买什么什么东西，我就是想获取点儿资源，对于服务器那边的还不是很了解，不过这可以是下一个学习目标。</p>
<a id="more"></a>
<p>所以在琢磨了两天之后有了这个使用iOS原生语言OC实现的网络爬虫。</p>
<blockquote>
<p>目的：使用OC做定向爬虫，主要爬取豆瓣电影的TOP250排行、最近热映、本周电影排行进行展示<br>工具：XPath基础知识、DOM基础知识、HTTP网络请求、iOS平台下的OC语言的XML/HTML解析器(Ono或者hpple)、以及一个豆瓣的网页</p>
</blockquote>
<p>首先说一下我对<a href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E8%9C%98%E8%9B%9B" target="_blank" rel="noopener"><code>网页爬虫</code></a>的理解:他是一种使用一定的技术手段在互联网上进行信息的抓取的技术。一般说到爬虫，第一个想到的方法就是使用<code>Python</code>编写，确实python在用于网页爬取的时候有比较大的优势，框架比较多，代码简洁。插一句，前几天小侄女参加一个什么微信拉票的活动，老哥让我给投票，我想能不能写个什么拉票神器之类的获取个高票，最后还是放弃了，一个是自己不会，另一个是如果发现非法票源，取消资格之类的警告。期间问过我们公司一个同事，如何写一个拉票软件，用什么写。他说，什么都能写啊，你们iOS开发的OC都可以写，只不过不同语言方式不一样，效率不同罢了。</p>
<p>现在想来，也对，如果python可以爬虫，在OC上其实也是可以使用类似的方法进行爬虫的，关键是找到方法。如果使用OC来进行爬虫，需要找到相关类库，但是毕竟不是专门的网络信息抓取工具，在类库的使用下还是需要做很多的工作才能得到想要的资源。庆幸找到了两个类库，一个是matt的<a href="https://github.com/mattt/Ono" target="_blank" rel="noopener">Ono</a>，一个是top的<a href="https://github.com/topfunky/hpple" target="_blank" rel="noopener">hpple</a>。最先接触的是hppla，但是由于当时没有<a href="http://www.w3school.com.cn/xpath/" target="_blank" rel="noopener"><code>XPath</code></a>这方面的概念，简单的看了下，现在要用的时候拿来自己还是不能够了解他的原理，而且输出日志实在是看不懂。在matt的github下找到了Ono，简洁，这一点就够了。</p>
<h2 id="爬虫分析">爬虫分析</h2><ul>
<li><p>第一步需要知道自己需要的资源在哪里：<a href="http://movie.doubam.com" target="_blank" rel="noopener"><code>豆瓣</code></a>，我要爬取豆瓣的新片榜单，就需要在浏览器打开他新片榜的网址。</p>
</li>
<li><p>具体在哪里：每一个界面上显示的东西都是由一个个DOM节点组成的，所以需要的资源就是某一个或者某一些节点</p>
<img src="/2016/01/07/douban-movie-spider/dbdom.png">
</li>
<li><p>如何找到他：使用XPath或者CSS选择器可以找到节点位于文档中的唯一位置，这里只使用XPath进行节点的获得，对于CSS选择器的获取方法，不是很熟练</p>
<img src="/2016/01/07/douban-movie-spider/xpath.png">
</li>
<li><p>最后使用不同平台上的语言特有的方法对节点的数据进行获取。</p>
</li>
</ul>
<p>大致流程就是这样了，下面进行实例抓取豆瓣电影TOP250、新片榜、本周排名三个板块的数据。</p>
<h2 id="架构搭建">架构搭建</h2><p>这是在慕课网上看python的时候截的一张python爬虫架构，由于前期学习的时候是把所有的代码都写在了一个文件中，对功能的划分基本上是没有，所以在转到原生语言OC中进行开发就要进行功能划分了。</p>
<img src="/2016/01/07/douban-movie-spider/spider_framework.png">
<h3 id="NetWork_Request">NetWork Request</h3><p>需要一个网络请求类，万能的网络请求<code>AFN</code>，使用<code>HLLRequestManager</code>对其进行封装调用，并建一个<code>AFHTTPSessionManager</code>的子类：<code>HLLNetClient</code>在里面进行一些操作，主要的操作就是对<code>header</code>进行修改，对<code>responseSerializer</code>进行修改。</p>
<p>修改header主要的目的是伪装成一个电脑浏览器，而不是移动端浏览器，因为现在的网站都已经适配了移动和PC，移动设备下获得的HTML中的DOM树不同于PC下的，这里是抓取PC浏览器下豆瓣的数据，所以需要把网络请求模拟成是PC浏览器发的（还可以防止mac地址被禁？），使用用户代理–<code>User-Agent</code>来模拟不同的设备，不同的浏览器：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NSString * randomUserAgent()&#123;</span><br><span class="line">    </span><br><span class="line">    NSArray * userAgents = <span class="comment">@[@</span><span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 Safari/537.36"</span>,</span><br><span class="line">                             <span class="comment">@"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.114 Safari/537.36",</span></span><br><span class="line"><span class="comment">                             @</span><span class="string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:36.0) Gecko/20100101 Firefox/36.0"</span>,</span><br><span class="line">                             <span class="comment">@"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.94 Safari/537.36",</span></span><br><span class="line"><span class="comment">                             @</span><span class="string">"Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6; en-US) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4 Safari/533.20.27"</span>];</span><br><span class="line">    <span class="keyword">return</span> userAgents[arc4random() % userAgents.count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在header的设置中还需要设置<code>Host</code>：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="literal">self</span>.requestSerializer <span class="built_in">set</span>Value:@<span class="string">"movie.douban.com"</span> <span class="keyword">for</span>HTTPHeaderField:@<span class="string">"Host"</span>];</span><br></pre></td></tr></table></figure>
<p>对<code>responseSerializer</code>的修改就简单地多了，基本上对着<br><img src="/2016/01/07/douban-movie-spider/network.png"><br>设置一下就行了：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.responseSerializer = [AFHTTPResponseSerializer serializer];</span><br><span class="line">  	self.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@"application/json<span class="string">", @"</span><span class="keyword">text</span>/plain<span class="string">", @"</span><span class="keyword">text</span>/javascript<span class="string">", @"</span><span class="keyword">text</span>/json<span class="string">", @"</span><span class="keyword">text</span>/html<span class="string">",@"</span>application/xhtml+xml<span class="string">",@"</span>application/xml<span class="string">",@"</span><span class="keyword">image</span>/webp<span class="string">", nil];</span></span><br></pre></td></tr></table></figure>
<h3 id="HTML_Parse">HTML Parse</h3><p>需要一个HTML解析器，也就是<code>HLLHTMLParseManager</code>。用它，这个单例，进行从网络请求下来的数据的HTML中DOM的解析，这个也是对Ono的一个封装，以后如果觉得Ono使用不是很方便或者不能达到要求要转换成hpple，在这里进行修改就可以自由切换了，说实话，后来才发现hpple也是很好用的(逃)。</p>
<p>基本上需要的功能类就这些了，其中解析器需要做的就是对于不同网络请求下来的文档数据，一般是以data数据流返回，进行DOM解析，解析出来不同的数据，供外部使用。难点就在于内部的parse，比较枯燥，这里举一个例子。</p>
<p>解析<a href="https://movie.douban.com/top250" target="_blank" rel="noopener">TOP250</a>请求下来的文档数据，通过XPath找到电影图片的<code>src</code>链接，使用<code>Ono</code>进行解析:<br><img src="/2016/01/07/douban-movie-spider/movies.png"><br>可以看出来，每一个电影内容都在这个<code>li</code>标签下，所以说先获得他的父标签<code>ol</code>，然后通过<code>children</code>属性得到所有的<code>li</code>标签，通过<code>li</code>进行他子类标签的获取，需要img的使用img的XPath获取，需要name的使用name的XPath获取，说的真费劲，代码如下：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ONOXMLDocument * <span class="attr">document</span> = [ONOXMLDocument HTMLDocumentWithData:data error:&amp;error];</span><br><span class="line"></span><br><span class="line">// 这个就是使用XPath获得的标签在文档中的位置</span><br><span class="line">   NSString * <span class="attr">olPath</span> = @<span class="string">"//*[@id=\"</span>content\<span class="string">"]/div/div[1]/ol[@class=\"</span>grid_view\<span class="string">"]"</span>;</span><br><span class="line">   </span><br><span class="line">   ONOXMLElement * <span class="attr">olELement</span> = [document firstChildWithXPath:olPath];</span><br><span class="line">   NSArray * <span class="attr">olElementChildern</span> = olELement.children;</span><br><span class="line"></span><br><span class="line">   NSMutableArray  * <span class="attr">movies</span> = [NSMutableArray array];</span><br><span class="line">   for (NSUInteger <span class="attr">index</span> = <span class="number">0</span>; index &lt; olElementChildern.count; index ++) &#123;</span><br><span class="line">       HLLMovie * <span class="attr">movie</span> = [self hll_parseTOP250MovieWithTrElement:olELement index:index];</span><br><span class="line">       [movies addObject:movie];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>然后是对需要的内容在不同的<code>li</code>标签下使用XPath进行获取，真的很烦。。。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (HLLMovie *) hll_parseTOP250MovieWithTrElement:(ONOXMLElement *)element index:(NSUInteger)index&#123;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span>    <span class="regexp">//</span>*[@id=<span class="string">"content"</span>]<span class="regexp">/div/</span>div[<span class="number">1</span>]<span class="regexp">/ol/</span>li[<span class="number">1</span>]</span><br><span class="line"><span class="regexp">//</span>    <span class="regexp">//</span>*[@id=<span class="string">"content"</span>]<span class="regexp">/div/</span>div[<span class="number">1</span>]<span class="regexp">/ol/</span>li[<span class="number">2</span>]</span><br><span class="line">    ...</span><br><span class="line"><span class="regexp">//</span>    <span class="regexp">//</span>*[@id=<span class="string">"content"</span>]<span class="regexp">/div/</span>div[<span class="number">1</span>]<span class="regexp">/ol/</span>li[<span class="number">25</span>]</span><br><span class="line">    NSMutableString * liXPath = [NSMutableString stringWithFormat:@<span class="string">"//li[%lu]"</span>,(unsigned long)index + <span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    ONOXMLElement * liElement = [element firstChildWithXPath:liXPath];</span><br><span class="line"></span><br><span class="line">    ONOXMLElement * imgElement = (&#123;</span><br><span class="line"><span class="regexp">//</span>        <span class="regexp">//</span>*[@id=<span class="string">"content"</span>]<span class="regexp">/div/</span>div[<span class="number">1</span>]<span class="regexp">/ol/</span>li[<span class="number">1</span>]<span class="regexp">/div/</span>div[<span class="number">1</span>]<span class="regexp">/a/img</span></span><br><span class="line">        NSString * imgXPath = fullElementXPathWithFatherXPath(@<span class="string">"div/div[@class=\"pic\"]/a/img"</span>, liXPath);</span><br><span class="line">        imgElement = [liElement firstChildWithXPath:imgXPath];</span><br><span class="line">        NSLog(@<span class="string">"img:%@"</span>,imgElement.attributes[@<span class="string">"src"</span>]);</span><br><span class="line">        imgElement;</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">    HLLMovie * movie = (&#123;</span><br><span class="line">    </span><br><span class="line">        movie = [[HLLMovie alloc] init];</span><br><span class="line">        movie.img = imgElement.attributes[@<span class="string">"src"</span>];</span><br><span class="line">		...</span><br><span class="line">        movie;</span><br><span class="line">    &#125;);</span><br><span class="line">    return movie;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="写在后面">写在后面</h2><p>虽然可以使用网络抓包工具抓取豆瓣客户端的网络请求，得到json数据进行展示，恩，我知道这种方法，现在只是想换一种方法实现一下而已。</p>
<p>由于这是一个定向爬虫，也就说如果豆瓣稍微改变一下DOM，这个爬虫不能用了，就需要针对于豆瓣的修改进行改进了，幸好这里just for fun。</p>
<p>还有，豆瓣的工程师也是蛮逗的，这两天看豆瓣的代码，每次往浏览器右下角看都会笑起来，有种做坏事被发现了的尴尬😜：<br><img src="/2016/01/07/douban-movie-spider/db.png"></p>
<p>这是<a href="https://github.com/Yrocky/HLLDoubanSpider" target="_blank" rel="noopener">工程代码</a>，也许不久之后我会做一些好玩的东西在里面，也许不会，也许明天豆瓣就把DOM改了，这个工程就废了，也许他一直懒得改。</p>
<p>done。</p>
</div><div class="post-tags-box"><a class="tag-link" href="/tags/python/">python</a>, <a class="tag-link" href="/tags/爬虫/">爬虫</a></div></article></div><div class="post-nav"><div class="prev-wrap col-md-6 col-xs-6"><i class="fa fa-angle-double-left"></i><a href="/2016/02/26/teach-Girl-How-To-Use-UITableView-With-A-Series-Demo/" class="prev-post">通过Sample Code逐步学习使用UITableView</a></div><div class="next-wrap col-md-6 col-xs-6"><a href="/2015/12/28/realm/" class="next-post">Realm数据库</a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;Yrocky&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a> by SHAW</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>