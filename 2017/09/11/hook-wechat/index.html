<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><title>Yrocky's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Yrocky</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">å¾®ä¿¡ï¼Œè®©ç”Ÿæ´»æ›´ç¾å¥½  æ’ä»¶ï¼Œè®©å¾®ä¿¡æ›´æ–¹ä¾¿</h1><div class="post-info">9æœˆ 11æ—¥ 2017</div><div class="post-entry"><img src="/2017/09/11/hook-wechat/wechat_title.png" alt="title" title="title">
<p>ä¸å¾—ä¸è¯´ï¼Œå¾®ä¿¡ç°åœ¨å·²ç»æˆä¸ºäº†ç”Ÿæ´»ä¸­è‡³å…³é‡è¦çš„ä¸€ä¸ªå·¥å…·ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™éš¾å…ä¼šæƒ³è¦ä¸€äº›ä¸ªæ€§åŒ–çš„åŠŸèƒ½ï¼Œä½†æ˜¯è¿™äº›åŠŸèƒ½åŸç‰ˆappå†…æ²¡æœ‰æä¾›ï¼Œé‚£ä¹ˆå°±è¦é è‡ªå·±åŠ¨æ‰‹äº†ã€‚æ°å·§å‰æ®µæ—¶é—´çœ‹åˆ°<a href="http://iosre.com/t/topic/8696" target="_blank" rel="external">é€†å‘ç¤¾åŒº</a>ä¸­çš„å¤§å¤§ä»¬åœ¨iOSOpenDevåŸºç¡€ä¸Šæ•´å‡ºäº†ä¸ªæ›´åŠ å¥½ç”¨çš„<a href="https://github.com/AloneMonkey/MonkeyDev.git" target="_blank" rel="external">MonkeyDev</a>ï¼Œç”±äºiOSOpenDevä¸å†æ›´æ–°å¼•èµ·çš„å¾ˆå¤šä¸ä¾¿å’Œæäº‹æƒ…å‰é…ç½®å„ç§éº»çƒ¦çš„å‘½ä»¤è®©æˆ‘éƒ½å¿«æ”¾å¼ƒé€†å‘äº†ï¼Œè¿™ä¸ªæ–°çš„Devè®©æˆ‘åˆæœ‰äº†ç©ä¸€æŠŠçš„å¿ƒæ€ã€‚</p>
<p>ä½¿ç”¨MonkeyDevå°†ä»¥å‰çš„ä¸€äº›tweakæ”¾è¿›å»ç¼–è¯‘ä¹‹åå¯ä»¥å®Œç¾çš„è·‘åœ¨æ‰‹æœºä¸Šäº†ï¼Œç°åœ¨é€†å‘çœŸçš„æ˜¯æœ‰ç‚¹å‚»ç“œæ“ä½œäº†ï¼Œåªéœ€è¦å…³å¿ƒå¦‚ä½•å°†è‡ªå·±çš„æƒ³æ³•hookå‡ºæ¥ï¼Œå…¶ä½™çš„ç¹å¤æ“ä½œéƒ½äº¤ç»™Devå°±å¥½äº†ã€‚é‚£å¥½äº†ï¼Œè¿™æ¬¡å°±å¥½å¥½ä½“éªŒä¸€ä¸‹MonkeyDevå†™ä¸€ä¸ªå¾®ä¿¡åŠ©æ‰‹çš„tweakï¼Œhookçš„æ€è·¯ä¼šä¸€æ­¥ä¸€æ­¥çš„åˆ—å‡ºæ¥ï¼Œä»£ç åŸºæœ¬ä¸ä¼šè´´å‡ºæ¥ï¼ŒåŠŸèƒ½çš„è¯éƒ½æ˜¯ä¸€äº›æœ‰å®é™…éœ€æ±‚ä½†ä¸çŸ¥é“å¯ä¸å¯ä»¥å®ç°çš„ğŸ˜œï¼Œä¸è¿‡80%åœ¨æ¢ç´¢åéƒ½å¯ä»¥å®ç°ã€‚</p>
<p>æ¶‰åŠåˆ°çš„åŠŸèƒ½ä¸åŒ…æ‹¬ï¼šå„ç§å§¿åŠ¿æŠ¢çº¢åŒ…ã€é˜²æ­¢æ¶ˆæ¯æ’¤å›ã€ä¿®æ”¹å¾®ä¿¡æ­¥æ•°ã€ç¾¤èŠé»‘åå•ï¼Œå› ä¸ºè¿™äº›åŠŸèƒ½éƒ½å·²ç»æœ‰å¾ˆè¯¦ç»†çš„æ•™ç¨‹è®²è§£äº†ï¼Œå¹¶ä¸”å¦‚æœå¾®ä¿¡ä¸æ”¹ç‰ˆï¼ŒåŸºæœ¬çš„hookæ€è·¯æ˜¯ä¸ä¼šå˜çš„ã€‚è™½ç„¶ä¸ä¼šæ¶‰åŠåˆ°è¿™äº›ï¼Œä½†æ˜¯ä¹Ÿä¼šå°†å‰äººçš„æ€è·¯æ•´ç†åˆ—å‡ºæ¥ï¼Œä»¥ä¾›æŸ¥é˜…å­¦ä¹ ã€‚å¦å¤–é’ˆå¯¹äºä¿®æ”¹å¾®ä¿¡æ­¥æ•°ï¼Œæˆ‘åšäº†ä¸€ä¸ªæ›´åŠ æœ‰è¶£çš„å¯ç©åŠŸèƒ½ï¼Œè™½ç„¶æ˜¯æ”¹æ­¥æ•°ï¼Œä½†æ˜¯ä¹Ÿè¦æ”¹çš„ä¸é‚£ä¹ˆæ˜æ˜¾ã€‚</p>
<p>here we go.</p>
<a id="more"></a>
<h3 id="1-è‡ªåŠ¨æŠ¢çº¢åŒ…">1.è‡ªåŠ¨æŠ¢çº¢åŒ…</h3><p>æ€è·¯å¤§è‡´ä¸ºï¼šhookæ”¶åˆ°çº¢åŒ…çš„æ¶ˆæ¯â€”&gt;è¿›è¡Œçº¢åŒ…è§£æâ€”&gt;æ¨¡æ‹Ÿæ‰§è¡ŒæŠ¢çš„æ“ä½œ</p>
<p><a href="http://www.jianshu.com/p/189afbe3b429" target="_blank" rel="external">ç®€ä¹¦ï¼šä¸€æ­¥æ­¥å®ç°å¾®ä¿¡æŠ¢çº¢åŒ…(éè¶Šç‹±)</a></p>
<p><a href="http://www.jianshu.com/p/677287a002be" target="_blank" rel="external">ç®€ä¹¦ï¼šå¾®ä¿¡çº¢åŒ…å®ç°åŸç†</a></p>
<p><a href="https://github.com/buginux/WeChatRedEnvelop" target="_blank" rel="external">Githubï¼šTweakæºç </a></p>
<h3 id="2-é˜²æ­¢æ¶ˆæ¯æ’¤å›">2.é˜²æ­¢æ¶ˆæ¯æ’¤å›</h3><p>æ€è·¯ä¸ºï¼šhookæ”¶åˆ°ã€æ’¤å›æ¶ˆæ¯ã€‘çš„æ¶ˆæ¯ï¼Œä¸æ‰§è¡Œåˆ é™¤æ¶ˆæ¯çš„æ“ä½œï¼Œç„¶åæ·»åŠ ä¸€ä¸ªæœ¬åœ°æ¶ˆæ¯æç¤ºé˜»æ­¢äº†ä¸€æ¡æ¶ˆæ¯æ’¤å›ã€‚</p>
<p><a href="http://www.jianshu.com/p/7f65287a2e7a" target="_blank" rel="external">ç®€ä¹¦ï¼šMacç‰ˆå¾®ä¿¡é˜²æ¶ˆæ¯æ’¤å›  æ–‡ç« ä¸­æœ‰githubåœ°å€</a></p>
<h3 id="3-ç¾¤èŠé»‘åå•">3.ç¾¤èŠé»‘åå•</h3><p>å¤§è‡´æ€è·¯ä¸ºï¼šä½¿ç”¨ä¸€ä¸ªæ•°ç»„è®°å½•é€‰æ‹©çš„é»‘åå•åˆ°æœ¬åœ°ï¼Œhookè·å–æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ä¸”åœ¨æ•°ç»„ä¸­ï¼Œå°±ç›´æ¥è¿”å›ã€‚</p>
<p><a href="https://github.com/buginux/WeChatRedEnvelop" target="_blank" rel="external">Githubï¼šTweakæºç </a></p>
<h3 id="4-èŠ±æ ·ä¿®æ”¹å¾®ä¿¡æ­¥æ•°">4.èŠ±æ ·ä¿®æ”¹å¾®ä¿¡æ­¥æ•°</h3><p>æ‰€æœ‰çš„ä¿®æ”¹å¾®ä¿¡æ­¥æ•°çš„æ“ä½œéƒ½æ˜¯åœ¨è·å–åœ¨å¾®ä¿¡æ­¥æ•°çš„æ—¶å€™hookï¼Œç„¶åæƒ³è¦å±•ç¤ºçš„æ•°å­—ã€‚</p>
<p>å¯¹æ¯”è¿™ç§å¤ªè¿‡ç—•è¿¹åŒ–çš„æ”¹æ­¥æ•°ï¼Œåœ¨ä¿®æ”¹æ­¥æ•°çš„æ—¶å€™å¢åŠ ä¸€äº›å¯ç©æ€§çš„æ“ä½œï¼Œè®©ä¿®æ”¹æ­¥æ•°ä¸é‚£ä¹ˆæ˜æ˜¾ã€‚é™¤äº†åŸºç¡€çš„å›ºå®šæ­¥æ•°ï¼Œä¸»è¦çš„ç©æ³•æœ‰ä¸¤ä¸ªï¼šä¸ã€ç¬¬ä¸€åã€ã€ã€æœ€åä¸€åã€ã€ã€ä»»æ„ä¸€åã€å¤š/å°‘næ­¥ï¼›é€‰æ‹©æ’è¡Œæ¦œä¸­çš„æŸä¸€ä¸ªäººæ¯”ä»–å¤š/å°‘næ­¥ã€‚è¿™äº›éƒ½æ˜¯é€»è¾‘çš„å¤„ç†ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œçœ‹å®˜ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•ç¼–å†™ä¸€å¥—é€»è¾‘æ¥ä¿®æ”¹æ­¥æ•°ã€‚</p>
<p>ä¸»è¦çš„éš¾ç‚¹åœ¨äºè·å–åŠ å…¥å¾®ä¿¡è¿åŠ¨æ’è¡Œæ¦œçš„æ‰€æœ‰ç”¨æˆ·ä¾›é€‰æ‹©ï¼Œè¿™ä¸ªæ—¢ç„¶å¾®ä¿¡è¿åŠ¨æ’è¡Œæ¦œä¸­æœ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–åˆ°ã€‚</p>
<p><strong>è·å–å¾®ä¿¡è¿åŠ¨å¥½å‹åˆ—è¡¨</strong>ï¼šåœ¨æ’è¡Œæ¦œä¸­è·å–å¥½å‹åˆ—è¡¨çš„æ—¶å€™æ˜¯ä½¿ç”¨çš„ä¸»åŠ¨è¯·æ±‚ï¼Œå…·ä½“çš„å¦‚ä½•è¯·æ±‚éƒ½æ”¾åœ¨äº†<strong>DeviceRankSnsMgr</strong>ç±»é‡Œé¢ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»è¿›è¡Œæ¨¡æ‹Ÿè·å–å¾®ä¿¡è¿åŠ¨å¥½å‹åˆ—è¡¨ã€‚è¯·æ±‚æ’è¡Œç‰ˆæ˜¯é€šè¿‡è¿™ä¸ªç±»çš„<code>- (void)getUserRankListCount:(id)arg1 chanpionUsername:(id)arg2 brandUserName:(id)arg3</code>æ–¹æ³•å‘å‡ºçš„ï¼Œå¯¹äºè¿™ä¸ªè¯·æ±‚çš„å“åº”æ˜¯<code>- (void)handleRankGetUserRankLikeResponse:(ProtobufCGIWrap *)arg1</code>å›è°ƒï¼Œå…¶ä¸­<strong>ProtobufCGIWrap</strong>çš„æœ‰ç”¨ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">ProtobufCGIWrap </span>: NSObject </span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) GetUserRankLikeCountResponse *m_pbResponse; <span class="comment">// @synthesize m_pbResponse;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) GetUserRankLikeCountRequest *m_pbRequest; <span class="comment">// @synthesize m_pbRequest;</span></span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int m_uiCgi; <span class="comment">// @synthesize m_uiCgi;</span></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œ<code>m_pbResponse</code>å’Œ<code>m_pbRequest</code>åˆ†åˆ«æŒ‡ä»£çš„å“åº”å’Œè¯·æ±‚ï¼Œè¿™ä¸¤ä¸ªå±æ€§å¯¹åº”çš„ç±»å¦‚ä¸‹ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">GetUserRankLikeCountRequest </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *appusername; <span class="comment">// @dynamic appusername;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *championname; <span class="comment">// @dynamic championname;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *rankid; <span class="comment">// @dynamic rankid;</span></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">likeItem </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int likecount; <span class="comment">// @dynamic likecount;</span></span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int likestate; <span class="comment">// @dynamic likestate;</span></span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int ranknum; <span class="comment">// @dynamic ranknum;</span></span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int score; <span class="comment">// @dynamic score;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *username; <span class="comment">// @dynamic username;</span></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">GetUserRankLikeCountResponse </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSMutableArray *follows; <span class="comment">// å…³æ³¨çš„å¥½å‹æ’è¡Œä¿¡æ¯ &lt;Follow *&gt;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSMutableArray &lt;likeItem *&gt;*friendlikelist; <span class="comment">// @dynamic friendlikelist;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSMutableArray *likeuserlist; <span class="comment">// @dynamic likeuserlist;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *rankid; <span class="comment">// @dynamic rankid;</span></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p>
<p>åˆ°æ­¤å·²ç»å¯ä»¥ç›´åˆ°å¦‚ä½•è¿›è¡Œè¯·æ±‚ï¼Œä»¥åŠè·å–åˆ°ä»€ä¹ˆæ ·çš„æ•°æ®ã€‚æ¥ç€hopper<strong>DeviceRankSnsMgr</strong>çš„å‘é€è¯·æ±‚å‡½æ•°å¯ä»¥å¤§è‡´ç†å‡ºæ¥å¾®ä¿¡å‘é€è¯·æ±‚çš„æ–¹å¼ï¼š</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="atom">void</span>)<span class="atom">getUserRankListCount</span>:(<span class="atom">id</span>)<span class="atom">arg1</span> <span class="atom">chanpionUsername</span>:(<span class="atom">id</span>)<span class="atom">arg2</span> <span class="atom">brandUserName</span>:(<span class="atom">id</span>)<span class="atom">arg3</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="name">GetUserRankLikeCountRequest</span> * <span class="atom">request</span> = [[<span class="name">GetUserRankLikeCountRequest</span> <span class="atom">alloc</span>] <span class="atom">init</span>];</span><br><span class="line">    [<span class="atom">request</span> <span class="atom">setRankid</span>:@<span class="string">"latestRank"</span>];</span><br><span class="line">    [<span class="atom">request</span> <span class="atom">setAppusername</span>:@<span class="string">""</span>];</span><br><span class="line">    [<span class="atom">request</span> <span class="atom">setChampionname</span>:@<span class="string">""</span>];</span><br><span class="line"></span><br><span class="line">    <span class="name">ProtobufCGIWrap</span> * <span class="atom">cgiWrap</span> = [[<span class="name">ProtobufCGIWrap</span> <span class="atom">alloc</span>] <span class="atom">init</span>];</span><br><span class="line">    [<span class="atom">cgiWrap</span> <span class="atom">setM_pbRequest</span>:<span class="atom">request</span>];</span><br><span class="line">    [<span class="atom">cgiWrap</span> <span class="atom">setM_uiCgi</span>:<span class="number">0x412</span>];</span><br><span class="line"></span><br><span class="line">    <span class="name">MMServiceCenter</span> * <span class="atom">serviceCenter</span> = [<span class="name">MMServiceCenter</span> <span class="atom">defaultCenter</span>];</span><br><span class="line">    <span class="name">EventService</span> * <span class="atom">eventService</span> = [<span class="atom">serviceCenter</span> <span class="atom">getService</span>:[<span class="name">EventService</span> <span class="atom">class</span>]];</span><br><span class="line">    <span class="atom">unsigned</span> <span class="atom">int</span> <span class="atom">flag</span> = [<span class="atom">eventService</span> <span class="name">CreateProtobufEvent</span>:<span class="atom">cgiWrap</span> <span class="name">Flag</span>:<span class="number">0x5</span>];</span><br><span class="line">    <span class="atom">if</span> (<span class="atom">flag</span> != <span class="number">0x0</span>)&#123;</span><br><span class="line">        [<span class="name">CAppUtil</span> <span class="atom">addPBEventObserverListItem</span>:<span class="atom">flag</span> <span class="atom">andValue</span>:<span class="atom">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å±•ç¤ºå¾®ä¿¡è¿åŠ¨å¥½å‹ä¾›é€‰æ‹©</strong>ï¼šå¾®ä¿¡ä¸­é€‰æ‹©å¥½å‹/ç¾¤/å…¬ä¼—å·ç­‰ç­‰ä¿¡æ¯çš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨çš„<strong>ContactSelectView</strong>ï¼Œå®ƒå†…éƒ¨ä¼šé€šè¿‡<strong>ContactsDataLogic</strong>è·å–æ‰€æœ‰çš„å¥½å‹/ç¾¤/å…¬ä¼—å·ä¿¡æ¯ï¼Œç„¶åå®ç°<strong>ContactSelectViewDelegate</strong>åè®®çš„ä»£ç†æ‰§è¡Œä¸€ä¸ª<code>- (_Bool)onFilterContactCandidate:(CContact *)arg1</code>æ“ä½œï¼Œå¯¹ä¼ å…¥çš„<strong>CContact</strong>è¿›è¡Œç­›é€‰å±•ç¤ºã€‚å› æ­¤ï¼Œä¸åŒçš„æ§åˆ¶å™¨å¯ä»¥ä½¿ç”¨<strong>ContactSelectView</strong>å®ç°é€‰æ‹©æ‰€æœ‰å¥½å‹ï¼Œé€‰æ‹©æ‰€æœ‰çš„èŠå¤©ç¾¤ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="5-éç¾¤ä¸»@æ‰€æœ‰äºº">5.éç¾¤ä¸»@æ‰€æœ‰äºº</h3><p>åœ¨ç¾¤ç»„ä¸­ï¼Œåªæœ‰ç¾¤ä¸»æ‰æœ‰@å…¨ä½“æˆå‘˜çš„åŠŸèƒ½ï¼Œç°åœ¨è¦å¢åŠ éç¾¤ä¸»ä¹Ÿå¯ä»¥ä½¿ç”¨@å…¨ä½“æˆå‘˜çš„åŠŸèƒ½ã€‚ç¾¤ä¸»@å…¨ä½“æˆå‘˜å°±æ˜¯é€šè¿‡ä¿®æ”¹ç¾¤å…¬å‘Šï¼Œå…ˆç ”ç©¶ç¾¤ä¸»ä¿®æ”¹å®Œäº†å…¬å‘Šä¹‹åçš„å‘æ¶ˆæ¯æµç¨‹ã€‚<strong>ChatRoomInfoEditDescViewController</strong>ç±»å°±æ˜¯ä¿®æ”¹ç¾¤å…¬å‘Šçš„æ§åˆ¶å™¨ï¼Œåœ¨ç‚¹å‡»ã€å®Œæˆã€æŒ‰é’®ä¹‹åå‡ºæ¥alertæç¤ºï¼Œç„¶åå¯ä»¥hook<code>- (void)alertView:(id)arg1 clickedButtonAtIndex:(long long)arg2;</code>å‡½æ•°ï¼Œä½¿ç”¨hopperè¿›è¡ŒDecopmile è¿™ä¸ªå‡½æ•°å‘ç°é‡Œé¢è¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p>
 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CGroupMgr * groupMgr = <span class="string">[[MMServiceCenter defaultCenter] getService:[CGroupMgr class]]</span>;</span><br><span class="line">NSString * usrName = self.m_chatRoomContact.m_nsUsrName;</span><br><span class="line">[groupMgr SetChatRoomDesc:usrName Desc:@<span class="string">"å…¬å‘Šå†…å®¹"</span> Flag:<span class="number">0x1</span>];</span><br></pre></td></tr></table></figure>
<p>å»æ¨¡æ‹Ÿä¸€ä¸‹è¿™ä¸ªæ“ä½œï¼Œå¤±è´¥ï¼Œç©¶å…¶åŸå› åº”è¯¥æ˜¯ï¼Œåªæœ‰ç¾¤ä¸»çš„idæ‰æœ‰æƒé™å»å‘é€æˆåŠŸè¿™ä¸ªæ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸€æ—¦å‘é€æˆåŠŸ(ä»¥ç¾¤ä¸»èº«ä»½)ï¼Œç¾¤å…¬å‘Šä¹Ÿå°±ä¼šæ”¹å˜ï¼Œè¿™æ ·ä¹Ÿå°±åªèƒ½ä½œç½¢äº†ã€‚</p>
<p>å¦å¤–å»hookæ¥æ”¶åˆ°çš„<code>ç¾¤ä¸»@æ‰€æœ‰äººçš„æ¶ˆæ¯</code>çš„æ—¶å€™å‘ç°<strong>(CMessageWrap *)wrap</strong>çš„ <code>m_nsMsgSource</code> å±æ€§å†…å®¹ä¸ºå¦‚ä¸‹(è¿™ä¸ªå±æ€§æ˜¯å¾®ä¿¡ç”¨æ¥å¯¹èŠå¤©æ¶ˆæ¯è¿›è¡Œçš„ä¸€å±‚xmlåŒ…è£¹)ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">msgsource</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">sequence_id</span>&gt;</span></span><br><span class="line">		656201926</span><br><span class="line">	<span class="tag">&lt;/<span class="title">sequence_id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">atuserlist</span>&gt;</span></span><br><span class="line">    	announcement@all</span><br><span class="line">	<span class="tag">&lt;/<span class="title">atuserlist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">msgsource</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>éœ€è¦sequence_idï¼Œè®°å½•æ“ä½œé¡ºåºçš„idï¼Œå¦å¤–ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ˜¯ã€announcement -&gt; ç¾¤å…¬å‘Šã€ï¼Œè¿™ä¸ªè·¯çœ‹æ¥åªèƒ½å†æ¬¡ä½œç½¢ã€‚</p>
<p>æ¢ä¸€ä¸ªç ”ç©¶æ–¹å‘ï¼Œä¸ªäººä¹Ÿæ˜¯å¯ä»¥@ä¸ªäººçš„ã€‚è¿™æ—¶å€™å°±æ˜¯æ™®é€šçš„å‘æ¶ˆæ¯ï¼Œä½†æ˜¯å…¶æ¶ˆæ¯<code>wrap.m_nsMsgSource</code>ä¸º<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">msgsource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">atuserlist</span>&gt;</span></span><br><span class="line">        ***å¾®ä¿¡å†…éƒ¨ä½¿ç”¨çš„ç”¨æˆ·id***</span><br><span class="line">    <span class="tag">&lt;/<span class="title">atuserlist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">msgsource</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæ”¾å…¥ä¸€ä¸ªidå°±å¯ä»¥å®Œæˆè‰¾ç‰¹æ”¹idçš„ç”¨æˆ·ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å°†å½“å‰ç¾¤é‡Œé¢çš„æ‰€æœ‰äººçš„<strong>å†…éƒ¨ç”¨æˆ·id</strong>éƒ½æ”¾åˆ°è¿™é‡Œé¢ï¼Œè¾¾åˆ°@æ‰€æœ‰äººçš„ç›®çš„å‘¢ï¼Ÿ</p>
<p>å®éªŒä¹‹åï¼Œå¯ä»¥çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸‹é¢è¦åšçš„å°±æ˜¯ï¼Œè·å–å½“å‰ç¾¤é‡Œé¢æ‰€æœ‰ç”¨æˆ·çš„<strong>å†…éƒ¨ç”¨æˆ·id</strong>ï¼Œæ‹¼æˆå­—ç¬¦ä¸²ï¼Œæ”¾å…¥è¿™ä¸ªå±æ€§çš„xmlä¸­ï¼Œè€Œè¿™ä¸ª<strong>å†…éƒ¨ä½¿ç”¨çš„ç”¨æˆ·id</strong>æ˜¯<strong>CContact</strong>ç±»çš„<code>m_nsUsrName</code>å±æ€§ï¼š<br> <figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NSArray</span> *<span class="literal">result</span> = [%c(<span class="type">CContact</span>) getChatRoomMemberWithoutMyself:knToUsr];</span><br><span class="line"><span class="type">NSMutableString</span> *<span class="type">string</span> = [<span class="type">NSMutableString</span> <span class="type">string</span>];</span><br><span class="line">[<span class="literal">result</span> enumerateObjectsUsingBlock:^(<span class="type">CContact</span> * obj, <span class="type">NSUInteger</span> idx, <span class="type">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">    [<span class="type">string</span> appendFormat:@<span class="string">",%@"</span>,[obj m_nsUsrName]];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="type">NSString</span> *sourceString = [<span class="type">string</span> substringFromIndex:<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">[@<span class="string">"&lt;msgsource&gt;&lt;atuserlist&gt;%@&lt;/atuserlist&gt;&lt;/msgsource&gt;"</span> , sourceString];</span><br></pre></td></tr></table></figure></p>
<h3 id="6-æ¶ˆæ¯é¢„è§ˆ">6.æ¶ˆæ¯é¢„è§ˆ</h3><p>åœ¨å…¬ä¼—å·å†…éƒ¨çš„ç½‘é¡µæµè§ˆä¿¡æ¯ã€çœ‹æœ‹å‹åœˆçš„æ—¶å€™æ¥äº†ä¿¡æ¯ï¼Œéœ€è¦é€€è¿”å›ä¸»é¡µé¢ï¼Œç„¶åå¦‚æœè¦å›åˆ°å…¬ä¼—å·ã€æœ‹å‹åœˆçš„ä½ç½®å°±è¦ä¸€æ­¥æ­¥çš„è¿”å›å›å»ã€‚å› æ­¤ï¼Œå¯¹è¦è·³è½¬åˆ°èŠå¤©å®¤çš„æ—¶å€™åšä¸€ä¸ªè®°å½•æµè§ˆçš„è®°å½•ï¼Œå°±å¯ä»¥åœ¨æ¶ˆæ¯å’Œç½‘é¡µæµè§ˆä¹‹é—´åˆ‡æ¢äº†ã€‚</p>
<p>éœ€è¦hookåˆ°æ”¶åˆ°èŠå¤©æ¶ˆæ¯çš„æ–¹æ³•ï¼Œè‡ªç„¶æ˜¯å“ªå“ªå„¿éƒ½æœ‰ä»–çš„<code>-[CMessageMgr AsyncOnAddMsg:MsgWrap:]</code>äº†ï¼Œç„¶ååœ¨è¿™é‡Œè®°å½•æ¶ˆæ¯å†…å®¹ï¼Œä½¿ç”¨é€šçŸ¥çš„æ–¹æ³•å°†äº‹ä»¶å¹¿æ’­å‡ºå»ã€‚åœ¨éœ€è¦çš„ç•Œé¢é€šè¿‡æ·»åŠ é€šçŸ¥ï¼Œå¯¹é€šçŸ¥ä¸­çš„å†…å®¹è¿›è¡Œå±•ç¤ºï¼Œæä¾›ä¸€ä¸ªè§†å›¾ï¼Œç‚¹å‡»çš„æ—¶å€™å¯ä»¥è°ƒæŠ“åˆ°å¯¹åº”çš„èŠå¤©å®¤ï¼Œè·³è½¬ä¹‹å‰éœ€è¦è®°å½•å½“å‰æ§åˆ¶å™¨çš„è°ƒç”¨æ ˆã€‚</p>
<p>å…¬ä¼—å·é˜…è¯»æ§åˆ¶å™¨ä¸ºï¼š<strong>MMWebViewController</strong>ï¼Œæœ‹å‹åœˆæ§åˆ¶å™¨ä¸ºï¼š <strong>WCTimeLineViewController</strong>ï¼Œæ‰€ä»¥å¯ä»¥hookè¿™ä¸¤ä¸ªæ§åˆ¶å™¨çš„<code>-viewDidLoad</code>æ–¹æ³•ï¼Œæ·»åŠ é€šçŸ¥ã€‚</p>
<p>æ›´åŠ æç«¯çš„æ˜¯ä¸ºæ‰€æœ‰æ§åˆ¶å™¨çš„çˆ¶ç±»<strong>MMUIViewController</strong>æ·»åŠ é€šçŸ¥ï¼Œä½†æ˜¯åœ¨èŠå¤©å®¤æ§åˆ¶å™¨<strong>BaseMsgContentViewController</strong>ä¸­ç§»é™¤é€šçŸ¥ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°ä¸ºæ‰€æœ‰éèŠå¤©å®¤ç•Œé¢æä¾›æ¶ˆæ¯é¢„è§ˆçš„åŠŸèƒ½äº†ã€‚</p>
<p>è¿™ä¸ªæ€è·¯æ˜¯å‚è€ƒ<a href="http://corbinchen.com/2016/02/26/æˆ‘æ˜¯å¦‚ä½•åˆ©ç”¨Xcodeè°ƒè¯•å¼€å‘å¾®ä¿¡æ¶ˆæ¯é¢„è§ˆæ’ä»¶çš„/" target="_blank" rel="external">è¿™ç¯‡åšæ–‡</a>ç†å‡ºæ¥çš„ï¼Œæˆ‘åªä¸è¿‡æ˜¯æ”¹è¿›äº†ä¸€äº›ä¸œè¥¿ã€‚ä½†æ˜¯è¿™ä¸ªæ€è·¯ä¸­æœ‰ä¸€ä¸ªbugï¼šä»å…¬ä¼—å·ç½‘é¡µç‚¹å‡»æ¶ˆæ¯é¢„è§ˆå›åˆ°èŠå¤©å®¤ï¼Œå†ä»èŠå¤©å®¤å›åˆ°å…¬ä¼—å·ç½‘é¡µï¼Œç„¶åå…¬ä¼—å·ç½‘é¡µä¸€æ­¥æ­¥popåˆ°æ ¹è§†å›¾æ§åˆ¶å™¨ï¼Œå†è¿›å…¥èŠå¤©å®¤ç‚¹å‡»å›åˆ°å…¬ä¼—å·ç½‘é¡µæŒ‰é’®ï¼Œä¼šå‘ç°æ•´ä¸ªç½‘é¡µä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè€Œä¸”å…¬ä¼—å·èŠå¤©ç•Œé¢æ˜¯é»‘çš„ã€‚ç›®å‰è¿˜æ²¡æœ‰æƒ³å‡ºæ¥è§£å†³åŠæ³•ã€‚</p>
<p><a href="http://corbinchen.com/2016/02/26/æˆ‘æ˜¯å¦‚ä½•åˆ©ç”¨Xcodeè°ƒè¯•å¼€å‘å¾®ä¿¡æ¶ˆæ¯é¢„è§ˆæ’ä»¶çš„/" target="_blank" rel="external">å‚è€ƒæ–‡ç« ï¼šæˆ‘æ˜¯å¦‚ä½•åˆ©ç”¨Xcodeè°ƒè¯•å¼€å‘å¾®ä¿¡æ¶ˆæ¯é¢„è§ˆæ’ä»¶çš„</a></p>
<h3 id="7-è‡ªåŠ¨å›å¤">7.è‡ªåŠ¨å›å¤</h3><p>è‡ªåŠ¨å›å¤è¯´ç™½äº†ï¼Œå°±æ˜¯æœ¬åœ°ä¿å­˜ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªåŒ¹é…è§„åˆ™ç±»ä¼¼äºä¸€ä¸ªkey-valueï¼Œkeyæ˜¯è¿›è¡ŒåŒ¹é…çš„è§„åˆ™ï¼Œä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼Œvalueæ˜¯åŒ¹é…æˆåŠŸä¹‹åçš„å›å¤æ¶ˆæ¯ã€‚ç„¶åhook<code>-[CMessageMgr AsyncOnAddMsg:MsgWrap:]</code>åˆ¤æ–­æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹å»åŒ¹é…æœ¬åœ°åˆ—è¡¨ï¼ŒåŒ¹é…æˆåŠŸäº†å°±è¿”å›å¯¹åº”è¦è‡ªåŠ¨å›å¤çš„å†…å®¹ã€‚è¿›è¡ŒåŒ¹é…çš„æ—¶å€™ä¸€å®šè¦æœ‰å°½é‡å¤šçš„åˆ¤æ–­æ¡ä»¶ï¼Œå¦åˆ™ä¼šå¼•èµ·<code>è‡ªå·±å‘ç»™è‡ªå·±ç„¶åå¾ªç¯å¾€å¤çš„è‡ªåŠ¨å›å¤</code>çš„bugã€‚</p>
<p>ä¸ºäº†é¿å…ä¸Šé¢æåˆ°çš„bugå‘ç”Ÿï¼Œé™¤äº†åœ¨hookæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ä¸¥è°¨çš„åˆ¤æ–­ï¼Œåœ¨è®¾ç½®åŒ¹é…è§„åˆ™çš„æ—¶å€™ä¹Ÿè¦å°½å¯èƒ½çš„é¿å…<code>.*</code>è¿™ç§ä»»ä½•æ–‡æœ¬éƒ½å¯ä»¥åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚å¦å¤–ä¸ºäº†è¯¯æ“ä½œï¼Œä»…æ”¯æŒå•èŠçš„æ—¶å€™å¯¹æ–¹å‘ç»™è‡ªå·±æ¶ˆæ¯çš„æ—¶å€™è¿›è¡ŒåŒ¹é…ï¼Œå¯åŠ¨è‡ªåŠ¨å›å¤ã€‚</p>
<img src="/2017/09/11/hook-wechat/wechat_autoreply.png" alt="autoreply" title="autoreply">
<h3 id="8-è°ƒè¯•å·¥å…·">8.è°ƒè¯•å·¥å…·</h3><p>åœ¨çœ‹åˆ°<a href="https://github.com/AloneMonkey/MonkeyDev/wiki/CocoaPods" target="_blank" rel="external">wiki</a>çš„æ—¶å€™å‘ç°æ”¯æŒpodsï¼Œä¾‹å­å°±æ˜¯è°ƒè¯•å·¥å…·<a href="https://github.com/Flipboard/FLEX" target="_blank" rel="external">FLEX</a>ï¼Œæœ¬æ¥æ˜¯æ‰“ç®—ä½¿ç”¨ç³»ç»Ÿæä¾›çš„è°ƒè¯•å·¥å…·æ¥å®ç°è°ƒè¯•åŠŸèƒ½çš„ï¼Œä½†æ˜¯ï¼Œå¾ˆæ˜æ˜¾ï¼Œåœ¨releaseæ¨¡å¼ä¸‹ï¼Œè°ƒè¯•å·¥å…·æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œä¸€ç›´æ˜¾ç¤ºä¸å‡ºæ¥ã€‚</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://ryanipete.com/blog/ios/swift/objective-c/uidebugginginformationoverlay/</span></span><br><span class="line"></span><br><span class="line">Class debugCls = <span class="built_in">NSClassFromString</span>(<span class="string">@"UIDebuggingInformationOverlay"</span>);</span><br><span class="line">[debugCls performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"prepareDebuggingOverlay"</span>)];</span><br></pre></td></tr></table></figure>
<p>æŒ‰ç…§wikiä¸­çš„åŠæ³•ä½¿ç”¨cocoaPodsè¿›è¡Œæ·»åŠ FLEXåˆ°é¡¹ç›®ä¸­ï¼Œç„¶åå°±å¯ä»¥åœ¨å¾®ä¿¡ä¸­ä½¿ç”¨FLEXè¿›è¡Œè°ƒè¯•ï¼Œå¾ˆæ–¹ä¾¿ï¼Œå¹¶ä¸”è¿˜æ˜¯å¼€æºçš„å·¥å…·ã€‚</p>
<h3 id="9-ä¸ºèŠå¤©é¢æ¿å¢åŠ æ’ä»¶">9.ä¸ºèŠå¤©é¢æ¿å¢åŠ æ’ä»¶</h3><p>æ’ä»¶é¢æ¿ã€è¾“å…¥æ¡†ã€è¡¨æƒ…ç­‰ç­‰éƒ½æ˜¯åŠ åœ¨<strong>SelectAttachmentViewController</strong>æ§åˆ¶å™¨ä¸­çš„ï¼Œè€Œ<strong>SelectAttachmentViewController</strong>çš„viewåŠ åˆ°<strong>MMInputToolView</strong>ä¸Šä¾›æ˜¾ç¤ºã€æ“ä½œçš„,ä»–ä»¬ä¹‹é—´çš„äº‹ä»¶å›è°ƒä½¿ç”¨çš„æ˜¯<strong>SelectAttachmentViewControllerDelegate</strong>åè®®ã€‚<strong>MMInputToolView</strong>æ˜¯åŠ åœ¨èŠå¤©å®¤æ§åˆ¶å™¨ä¸­çš„è§†å›¾ï¼Œä»–ä»¬ä¹‹é—´çš„äº‹ä»¶å›è°ƒæ˜¯ä½¿ç”¨çš„<strong>MMInputToolViewDelegate</strong>åè®®ã€‚</p>
<p><strong>SelectAttachmentViewController</strong>çš„<code>_arrAttachementObjectItems</code>å˜é‡æ˜¯ç”¨æ¥å­˜å‚¨æ’ä»¶å¯¹è±¡çš„ï¼Œå­˜å‚¨çš„å¯¹è±¡ä¸º<strong>AttachementObjectItem</strong>ç±»ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­æœ‰ç›®å‰æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæ’ä»¶éœ€è¦çš„æ‰€æœ‰ï¼šå›¾ç‰‡ã€æ–‡å­—ã€ç‚¹å‡»å›è°ƒSELï¼š<br> <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">AttachementObjectItem </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *nsTitle; <span class="comment">// @synthesize nsTitle=_nsTitle;</span></span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) UIImage *oImage; <span class="comment">// @synthesize oImage=_oImage;</span></span><br><span class="line"><span class="variable">@property</span>(nonatomic) SEL selAction; <span class="comment">// @synthesize selAction=_selAction;</span></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p>
<p>ç»“åˆä»¥ä¸Šå¯ä»¥ç†ä¸€ä¸‹æ’ä»¶çš„äº‹ä»¶å“åº”é¡ºåºä¸ºï¼š</p>
<ul>
<li>ä¸º<code>_arrAttachementObjectItems</code>æ•°ç»„æ·»åŠ çš„æ’ä»¶ç±»ä¸­çš„selActionæ˜¯æ’ä»¶åœ¨ç‚¹å‡»çš„æ—¶å€™</li>
<li>å»è¯¢é—®æ§åˆ¶å™¨(SelectAttachmentViewController)çš„ä»£ç† (MMInputToolView)</li>
<li>ç„¶åä»£ç†(MMInputToolView)å®ç°åè®®(SelectAttachmentViewControllerDelegate)ä¸­çš„æ–¹æ³•</li>
<li>è€Œä¸”ä»£ç†(MMInputToolView)è‡ªå·±ä¹Ÿæœ‰ä»–çš„ä»£ç†ï¼Œä¹Ÿå°±æ˜¯èŠå¤©å®¤æ§åˆ¶å™¨(BaseMsgContentViewController)</li>
<li>MMInputToolViewå†å°†äº‹ä»¶ä¼ é€’ç»™èŠå¤©æ§åˆ¶å™¨å»å®ç°æ’ä»¶ä¸­çš„æ“ä½œï¼Œåˆ°æ­¤å°±å®Œæˆäº†ä¸€ä¸ªæ’ä»¶çš„äº‹ä»¶è°ƒç”¨é“¾</li>
</ul>
<p>æŸ¥çœ‹å¤´æ–‡ä»¶å‘ç°<strong>SelectAttachmentViewController</strong>æ˜¯åœ¨<code>-initObjectItem</code>æ–¹æ³•ä¸­åˆå§‹åŒ–æ·»åŠ æ’ä»¶å¯¹è±¡åˆ°<code>_arrAttachementObjectItems</code>ä¸­çš„ï¼Œæ‰€ä»¥ï¼Œå°±ä»hookè¿™ä¸ªå‡½æ•°å¼€å§‹æŒ‰ç…§ä¸Šé¢çš„é€»è¾‘æ·»åŠ æ’ä»¶ã€‚</p>
<p>é‚£ä¹ˆä¸‹é¢å°±ç®€å•äº†ï¼ŒæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘</p>
<ol>
<li>hook <code>-initObjectItem</code>å‡½æ•°ä¸º<code>_arrAttachementObjectItems</code>æ•°ç»„æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„æ’ä»¶å¯¹è±¡</li>
<li>ä¸º<strong>MMInputToolView</strong>æ·»åŠ ä¸€ä¸ª <em>è‡ªå®šä¹‰æ’ä»¶ä¸­çš„éœ€è¦å“åº”çš„æ–¹æ³•</em></li>
<li>ä¸º<strong>BaseMsgContentViewController</strong>æ·»åŠ ä¸€ä¸ª<strong>MMInputToolView</strong>è¦ä¼ é€’è¿‡æ¥çš„æ’ä»¶å“åº”æ–¹æ³•çš„æ–¹æ³•</li>
</ol>
<img src="/2017/09/11/hook-wechat/wechat_attachment.png" alt="attachment" title="attachment">
<p>å®Œæˆä»¥ä¸Šä¹‹åå‘ç°ï¼Œç¾¤èŠå’Œå•èŠéƒ½æ·»åŠ äº†ä¸€ä¸ªæ’ä»¶ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸æ˜¯æƒ³è¦çš„ç»“æœï¼Œéœ€è¦æƒ³åŠæ³•ä¸ä¸ºå•èŠæ·»åŠ è‡ªå®šä¹‰æ’ä»¶ã€‚é‚£ä¹ˆå¯¹æ¯”ä¸€ä¸‹ç¾¤èŠå’Œå•èŠæ’ä»¶é¢æ¿çš„å·®åˆ«å¯ä»¥å‘ç°ï¼šç¾¤èŠå¯ä»¥ç¾¤è§†é¢‘ï¼Œç¾¤èŠä¸å¯ä»¥è½¬è´¦ï¼Œå•èŠåªå¯ä»¥å•ä¸ªè§†é¢‘ã€‚ä½¿ç”¨FLEXæŸ¥æ‰¾å‘ç°ä¸åŒçš„é¢æ¿ä¸­æœ‰å¥½å‡ ä¸ªå±æ€§æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸è¿‡å…¶ä¸­ä¸€ä¸ª<code>@property(nonatomic) _Bool allowMultiTalk;</code>å±æ€§çš„ä¸åŒæ˜¯å¾ˆèƒ½åŒºåˆ«å‡ºæ¥æ˜¯ç¾¤èŠè¿˜æ˜¯å•èŠã€‚å®éªŒä¸€ä¸‹ï¼Œç¡®å®å¯ä»¥åŒºåˆ†å‡ºæ¥ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªæ’ä»¶ï¼Œå¯ä»¥ä¸ºä¸Šé¢çš„<strong>@æ‰€æœ‰äºº</strong>åŠŸèƒ½åœ¨èŠå¤©å®¤å†…æ·»åŠ æ›´ä¾¿æ·çš„æ“ä½œå…¥å£ã€‚</p>
<h3 id="10-è¡¨æƒ…ç›¸å…³">10.è¡¨æƒ…ç›¸å…³</h3><p>è¡¨æƒ…ç›¸å…³æ˜¯ç›´æ¥ä½¿ç”¨çš„è¿™ä¸ªä»“åº“ï¼Œé‡Œé¢æœ‰å¯ä»¥ç›´æ¥ä»webé¡µé¢å°†å›¾ç‰‡(é™æ€å›¾ã€gifå›¾)ä¿å­˜ä¸ºè¡¨æƒ…ï¼Œå¹¶ä¸”ä¿®æ”¹äº†è¡¨æƒ…æœ€å¤§é™åˆ¶å°ºå¯¸ã€‚</p>
<p><a href="https://github.com/Mainstayz/WeChatWebEmoticon" target="_blank" rel="external">Githubï¼šä¸€é”®ä¿å­˜ä¸ºè¡¨æƒ…ï¼Œæ— è§†å¾®ä¿¡è¡¨æƒ…å¤§å°çš„é™åˆ¶</a></p>
<h3 id="11-å°†å·²å‘é€çš„æ–‡å­—æœ‹å‹åœˆåœ¨ç§å¯†/å…¬å¼€ä¹‹é—´åˆ‡æ¢">11.å°†å·²å‘é€çš„æ–‡å­—æœ‹å‹åœˆåœ¨ç§å¯†/å…¬å¼€ä¹‹é—´åˆ‡æ¢</h3><p>æœ‹å‹åœˆçš„å›¾ç‰‡å¯ä»¥è‡ªç”±çš„è¿›è¡Œã€ç§å¯†ã€-&gt;ã€å…¬å¼€ã€åˆ‡æ¢ï¼Œä½†æ˜¯æ–‡å­—å´æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œä¸€æ—¦åœ¨æ˜¯å‘é€æ–‡å­—æœ‹å‹åœˆçš„æ—¶å€™é€‰æ‹©éšç§ï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ˜¯éšç§ï¼Œä¸å¯ä»¥å†æ”¹ä¸ºå…¬å¼€ï¼Œç›¸åï¼Œé€‰æ‹©å…¬å¼€ï¼Œå°±ä¸å¯ä»¥å†æ”¹ä¸ºéšç§ã€‚å¦‚æœå›¾ç‰‡ç‰ˆå¯ä»¥è‡ªç”±åˆ‡æ¢ï¼Œé‚£ä¹ˆåŒä¸ºæœ‹å‹åœˆçš„æ–‡å­—ç‰ˆåº”è¯¥ä¹Ÿå¯ä»¥è¿›è¡Œåˆ‡æ¢çš„ã€‚</p>
<p>é¦–å…ˆï¼Œè¦æ‰¾åˆ°å›¾ç‰‡ç‰ˆå’Œæ–‡å­—ç‰ˆçš„åŒºåˆ«å’Œå…±åŒç‚¹ã€‚ä½¿ç”¨FLEXå‘ç°ï¼Œå›¾ç‰‡å’Œæ–‡å­—éƒ½æœ‰ä½¿ç”¨çš„<strong>WCDataItem</strong>æ¥è¡¨ç¤ºä¸€æ¡ï¼Œä¸è¿‡å›¾ç‰‡ä¸­æ˜¯åˆåŒ…äº†ä¸€å±‚ï¼Œä½¿ç”¨<strong>WCMediaItemWrap</strong>æ¥è¡¨ç¤ºï¼Œå…·ä½“éœ€è¦çš„ä¸œè¥¿å¦‚ä¸‹ï¼š<br> <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">WCDataItem </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) NSString *username;</span><br><span class="line"><span class="variable">@property</span>(nonatomic) _Bool isPrivate;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">WCMediaItemWrap </span>: NSObject</span><br><span class="line"><span class="variable">@property</span>(nonatomic) unsigned int index;</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) WCDataItem *parent;</span><br><span class="line"><span class="variable">@property</span>(retain, nonatomic) WCMediaItem *mediaItem;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure></p>
<p><strong>WCPhotoMutipleImageViewController</strong>æ˜¯å›¾ç‰‡ç‰ˆæœ¬çš„æ§åˆ¶å™¨ï¼Œé‡Œé¢çš„actionSheetå›è°ƒé‡Œé¢æœ‰è¿›è¡Œã€ç§å¯†/å…¬å¼€ã€çš„æ“ä½œï¼Œhopperä»–çš„<code>- (void)actionSheet:(WCActionSheet *)arg1 clickedButtonAtIndex:(long long)arg2;</code>æ–¹æ³•ä¼šå‘ç°ï¼Œåˆ†åˆ«è°ƒç”¨å¦‚ä¸‹çš„æ–¹æ³•:<br> <figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// è®¾ä¸ºå…¬å¼€</span><br><span class="line">- (<span class="atom">void</span>)<span class="atom">onMakePublic</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="name">WCMediaItemWrap</span> * <span class="atom">mediaItemWrap</span> = [<span class="atom">self</span> <span class="atom">getMediaItemWrapAnywayAt</span>:<span class="atom">self</span>.<span class="atom">m_iCurrentPage</span>];</span><br><span class="line">    <span class="name">WCFacade</span> * <span class="atom">facade</span> = [[<span class="name">MMServiceCenter</span> <span class="atom">defaultCenter</span>] <span class="atom">getService</span>:[<span class="name">WCFacade</span> <span class="atom">class</span>]];</span><br><span class="line">    <span class="name">WCDataItem</span> * <span class="atom">parent</span> = <span class="atom">mediaItemWrap</span>.<span class="atom">parent</span>;</span><br><span class="line">    [<span class="atom">facade</span> <span class="atom">setDataItemPublic</span>:<span class="atom">parent</span>];</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è®¾ä¸ºéšç§</span><br><span class="line">- (<span class="atom">void</span>)<span class="atom">onMakePrivate</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="name">WCMediaItemWrap</span> * <span class="atom">mediaItemWrap</span> = [<span class="atom">self</span> <span class="atom">getMediaItemWrapAnywayAt</span>:<span class="atom">self</span>.<span class="atom">m_iCurrentPage</span>];</span><br><span class="line">    <span class="name">WCFacade</span> * <span class="atom">facade</span> = [[<span class="name">MMServiceCenter</span> <span class="atom">defaultCenter</span>] <span class="atom">getService</span>:[<span class="name">WCFacade</span> <span class="atom">class</span>]];</span><br><span class="line">    <span class="name">WCDataItem</span> * <span class="atom">parent</span> = <span class="atom">mediaItemWrap</span>.<span class="atom">parent</span>;</span><br><span class="line">    [<span class="atom">facade</span> <span class="atom">setDataItemPrivate</span>:<span class="atom">parent</span>];</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é‡ç‚¹å°±æ˜¯é‡Œé¢çš„<strong>WCFacade</strong>ç±»çš„<code>-setDataItemPrivate:(WCDataItem *)arg1</code>å’Œ<code>-setDataItemPublic:(WCDataItem *)arg1</code>è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œæ–‡å­—ç‰ˆæœ¬å°±æ˜¯ä½¿ç”¨<strong>WCDataItem</strong>æ¥è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥ï¼ŒæŒ‰é“ç†ä¼ å…¥æ–‡å­—ç‰ˆçš„<strong>WCDataItem</strong>å®ä¾‹å°±å¯ä»¥è¿›è¡Œç§å¯†/å…¬å¼€çš„åˆ‡æ¢äº†ã€‚</p>
<p>ç»“åˆä»¥ä¸Š<strong>WCFacade</strong>å¤´æ–‡ä»¶ä¸­æœ‰ä»·å€¼çš„ä¿¡æ¯ä¸ºï¼š<br> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@interface</span> <span class="string">WCFacade :</span> NSObject</span><br><span class="line">- (<span class="typename">void</span>)<span class="string">setDataItemPublic:</span>(WCDataItem *)arg1;</span><br><span class="line">- (<span class="typename">void</span>)<span class="string">setDataItemPrivate:</span>(WCDataItem *)arg1;</span><br><span class="line"><span class="annotation">@end</span></span><br></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨æ–‡å­—æœ‹å‹åœˆè¯¦æƒ…ç•Œé¢è¿›è¡Œæ·»åŠ æ“ä½œå…¥å£ã€‚<strong>WCCommentDetailViewControllerFB</strong>å°±æ˜¯æ–‡å­—ç‰ˆæœ¬è¯¦æƒ…æ§åˆ¶å™¨ï¼Œä»–æœ‰ä¸€ä¸ªå±æ€§<code>@property(retain, nonatomic) WCDataItem *dataItem;</code>ä»£è¡¨å½“å‰çš„æœ‹å‹åœˆæ•°æ®ï¼Œç»“åˆå›¾ç‰‡æœ‹å‹åœˆéšç§/å…¬å¼€çš„æ“ä½œé€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§æ¥åšç§å¯†/å…¬å¼€æ“ä½œã€‚</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡å­—æœ‹å‹åœˆè®¾ä¸ºå…¬å¼€</span></span><br><span class="line">- (<span class="keyword">void</span>)_textDetailOnMakePublic</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//[self startLoadingBlocked];</span></span><br><span class="line">    W<span class="built_in">CFacade</span> * facade = [[MMServiceCenter defaultCenter] getService:[W<span class="built_in">CFacade</span> class]];</span><br><span class="line">    [facade setDataItemPublic:<span class="keyword">self</span><span class="variable">.dataItem</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–‡å­—æœ‹å‹åœˆè®¾ä¸ºéšç§</span></span><br><span class="line">- (<span class="keyword">void</span>)_textDetailOnMakePrivate</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//[self startLoadingBlocked];</span></span><br><span class="line">    W<span class="built_in">CFacade</span> * facade = [[MMServiceCenter defaultCenter] getService:[W<span class="built_in">CFacade</span> class]];</span><br><span class="line">    [facade setDataItemPrivate:<span class="keyword">self</span><span class="variable">.dataItem</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ä»¥ä¸Šçš„æ–¹æ³•ï¼Œç»æµ‹è¯•ï¼Œå‘ç°æ˜¯å¯ä»¥æŠŠæ–‡å­—ç‰ˆæœ¬æœ‹å‹åœˆè¿›è¡Œç§å¯†/å…¬å¼€çš„è½¬æ¢ã€‚</p>
<h3 id="12-èŠå¤©æœºå™¨äºº">12.èŠå¤©æœºå™¨äºº</h3><p>æ˜¯è‡ªåŠ¨å›å¤çš„å‡çº§ç‰ˆï¼Œtodo</p>
</div><div class="post-tags-box"><a class="tag-link" href="/tags/å­¦ä¹ /">å­¦ä¹ </a>, <a class="tag-link" href="/tags/å¾®ä¿¡/">å¾®ä¿¡</a>, <a class="tag-link" href="/tags/é€†å‘/">é€†å‘</a></div></article></div><div class="post-nav"><div class="next-wrap col-md-6 col-xs-6 col-md-offset-6 col-xs-offset-6"><a href="/2017/08/05/sketch/" class="next-post">ä½¿ç”¨Sketchè¿›è¡Œè®¾è®¡å­¦ä¹ </a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;Yrocky&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a> by SHAW</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>