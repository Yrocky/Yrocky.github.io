<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Yrocky's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link href="/css/bootstrap.min.css" rel="stylesheet"><link href="/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css" rel="stylesheet"></head><body><div class="wrap"><nav class="page-navigation"><div class="nav-container"><div class="page-header-logo"><h1 class="prince-log"><a href="/" class="home-link">Yrocky</a></h1></div><button type="button" data-toggle="collapse" data-target=".main-nav-items" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><ul class="collapse navbar-collapse main-nav-items"><li class="menu-item"><a href="/" target="_self">HOME</a></li><li class="menu-item"><a href="/archives/" target="_self">ARCHIVE</a></li></ul></div></nav><main class="prince-container"><div class="post"><article class="post-block"><h1 class="post-title">换个思路，让编程更加有意思</h1><div class="post-info">2017 5月 15日</div><div class="post-entry"><p>记录一些自己平常使用的另类编程方法，给繁复枯燥的代码平添一些乐趣。主要是从一些实际使用场景出发，探讨如何『偷懒』，让时间不那么浪费在重复修改代码上，即使修改也要让修改代码没那么麻烦。</p>
<blockquote>
<p>目的：</p>
<ul>
<li>解决冗余代码</li>
<li>减少样板代码的书写</li>
<li>使用方便</li>
</ul>
</blockquote>
<a id="more"></a>
<h3 id="1-关于ActionSheet点击响应不同事件的一个使用场景">1.关于ActionSheet点击响应不同事件的一个使用场景</h3><p>比较常用的一个场景是一个界面中，我们需要弹出来一个ActionSheet，里面有n多个选项可供用户来选择。从产品设计的角度来说，对应的n种操作就是一个可怕的定时炸弹，不确定产品是不是会对这n种选项进行一个任性的排列；而从写代码的角度来说，对于这n种操作，写一个if-else或者switch-case是一个正确的选择，但是写下来你就会发现：冗余。再加上有可能会有排序的改动，那更加是毁灭性的代码。</p>
<p>对于这种类型的地方，没有必要花费太多精力来书写以及维护代码，需要的是简洁且易维护。</p>
<p>可以考虑使用数组将分支的操作进行存储，然后在点击选择时就可以直观的进行其对应的操作。可惜在 中，选择子<code>@selector</code>既不是基础数据类型也不是对象，是不能够使用数组存储的，那么就只能使用C数组来存储了，写出来大概是这个样子：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)actionSheet:(<span class="built_in">UIActionSheet</span> *)actionSheet clickedButtonAtIndex:(<span class="built_in">NSInteger</span>)buttonIndex &#123;</span><br><span class="line"></span><br><span class="line">    SEL selectors[] = &#123;</span><br><span class="line">        <span class="keyword">@selector</span>(insertRow),</span><br><span class="line">        <span class="keyword">@selector</span>(insertSection),</span><br><span class="line">        <span class="keyword">@selector</span>(deleteSection)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buttonIndex &lt; <span class="keyword">sizeof</span>(selectors) / <span class="keyword">sizeof</span>(SEL)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span>(*imp)(<span class="keyword">id</span>, SEL) = (<span class="keyword">typeof</span>(imp))[<span class="keyword">self</span> methodForSelector:selectors[buttonIndex]];</span><br><span class="line"></span><br><span class="line">        imp(<span class="keyword">self</span>, selectors[buttonIndex]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样还是会带来两个问题，第一个是UIActionSheet的实现和方法是分开写的，第二个是即使这样还是需要维护两个数组，没有达到易维护的目的，但是好赖也比以前简单了许多。</p>
<p>第一个问题可以使用最新的<code>UIAlertController</code>的block来解决，但是这无疑又是一个问题，要写好多样板代码，这时候就需要对UIAlertController进行一下封装，使其使用起来更加简洁。</p>
<h3 id="2-对系统的UIAlertController进行封装">2.对系统的UIAlertController进行封装</h3><p>在iOS8.0之后系统就不推荐使用UIAlertView以及UIActionSheet，而使用了一个UIAlertController来替换他们两个。这样的做法对于混乱的视图展示层级来说确实是一个福音，并且可以使用block的方式来在一处处理对应的事件。但是，对于新的UIAlertController来说，要写好多的样板代码，一般来说，排版也不是很好看。</p>
<p>基于减少劳动力以及优化使用方式的目的，对系统的UIAlertController进行一层简单的封装。思路是使用协议的方式来约定是要显示的Alert以及ActionSheet类：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@protocol</span> HLLAlertActionSheetProtocol &lt;NSObject&gt;</span><br><span class="line"><span class="variable">@optional</span></span><br><span class="line">#pragma mark - config</span><br><span class="line"></span><br><span class="line">- (id&lt;HLLAlertActionSheetProtocol&gt;) <span class="attribute">title</span>:(NSString *)titile;</span><br><span class="line"><span class="selector-tag">-</span> (id&lt;HLLAlertActionSheetProtocol&gt;) <span class="selector-tag">message</span><span class="selector-pseudo">:(NSString</span> *)<span class="selector-tag">message</span>;</span><br><span class="line">...</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure>
<p>使用一个<code>HLLAlertActionSheet</code>类来生成对应的alert或者actionSheet类：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HLLAlertActionSheet</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (<span class="keyword">id</span>&lt;HLLAlertActionSheetProtocol&gt;) alert;</span><br><span class="line">+ (<span class="keyword">id</span>&lt;HLLAlertActionSheetProtocol&gt;) actionSheet;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HLLAlertActionSheet</span></span></span><br><span class="line"><span class="meta">#pragma mark - config</span></span><br><span class="line">+ (<span class="keyword">id</span>&lt;HLLAlertActionSheetProtocol&gt;) alert&#123;    </span><br><span class="line">    <span class="keyword">return</span> [HLLAlert alert];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>而对于alert以及actionSheet类来说，内部使用一个私有类来存储通过实现协议传入的设置，然后在<code>showIn:</code>方法中对UIalertContrller进行初始化、设置以及显示。一个alert类的部分内容如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">HLLAlert </span>: NSObject&lt;HLLAlertActionSheetProtocol&gt;</span><br><span class="line"></span><br><span class="line"><span class="variable">@property</span> (nonatomic ,strong) HLLAlertActionSheetModel * aModel;</span><br><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> <span class="selector-tag">-</span> <span class="selector-tag">config</span></span><br><span class="line">+ (HLLAlert *) <span class="selector-tag">alert</span>;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>其中实现协议方法时候把当前实例对象也返回出去：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (HLLAlert *) title:(<span class="built_in">NSString</span> *)titile&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.aModel.title = titile;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在使用的时候可以这样：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[[HLLAlertActionSheet alert]</span><br><span class="line">          title:@<span class="string">"举报这个人"</span>]</span><br><span class="line">         message:@<span class="string">"确定举报当前主播直播的内容违规"</span>]</span><br><span class="line">        buttons:@[@<span class="string">"取消"</span>,@<span class="string">"举报"</span>]] style:UIAlertActionStyleCancel index:0]</span><br><span class="line">      showIn:self] fetchClick:^(<span class="name">NSInteger</span> index) &#123;</span><br><span class="line">        </span><br><span class="line">        if (<span class="name">index</span> = <span class="number">1</span>) &#123;// 举报</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>对于传入的用于可选操作的内容，可以使用数组也可以使用类似于UIAlertView初始化的时候不定个数的字符串类型：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Default handle button type is `UIAlertActionStyleDefault`. */</span></span><br><span class="line">- (id&lt;HLLAlertActionSheetProtocol&gt;) <span class="keyword">buttons:(NSArray </span>*)<span class="keyword">buttons;</span></span><br><span class="line"><span class="keyword">/** </span>Explain some as above .这个采用多字符串的方式传递<span class="keyword">buttons，以应对button-fetch不对应的问题*/</span></span><br><span class="line"><span class="keyword">- </span>(id&lt;HLLAlertActionSheetProtocol&gt;) <span class="keyword">buttonTitles:(NSString </span>*)<span class="keyword">buttonTitles, </span>... NS_REQUIRES_NIL_TERMINATION<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>目前，没有做可以添加UITextField的封装，后续有时间再做。</p>
<h3 id="3-关于一个变量的实例化方式">3.关于一个变量的实例化方式</h3><p>其实这是<strong>小括号内联符合表达式</strong>写法–<code>A compound statement enclosed in parentheses.</code></p>
<p>想象一下，在对一个类的对象变量进行实例化的时候，往往需要写大量的关于这个对象变量的设置属性代码。</p>
<p>这种做法的最大的意义是将代码整理分块，将同一个逻辑的代码抱在一起；同时对于一个不需要复用的小段逻辑，免去了重量级函数的调用：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self.loginButton </span>= (&#123;</span><br><span class="line">        UIButton *<span class="keyword">button </span>= [UIButton <span class="keyword">buttonWithType:UIButtonTypeCustom];</span></span><br><span class="line"><span class="keyword"> </span>       ...</span><br><span class="line">        <span class="keyword">button;</span></span><br><span class="line"><span class="keyword"> </span>   &#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-使用位域进行代理方法实现与否的判断">4.使用位域进行代理方法实现与否的判断</h3><p>在使用代理的时候需要判断代理代理是否实现了协议方法，一般的方法就是使用if-else进行书写，但是这样的切砖代码比较枯燥，也没有一点儿技术性可言，所以按照EOC中的方法可以使用以下方法进行书写，</p>
<p>使用结构体进行位的标记位：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="function">interface <span class="title">KKGestureLockView</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> didBeginWithPasscode :<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> didEndWithPasscode : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> didCanceled : <span class="number">1</span>;</span><br><span class="line">    &#125; _delegateFlags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在设置代理的时候进行判断代理是否实现了相关协议方法，然后设置标记位：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">setDelegate:</span>(id&lt;KKGestureLockViewDelegate&gt;)delegate&#123;</span><br><span class="line"></span><br><span class="line">    _delegate = delegate; </span><br><span class="line"></span><br><span class="line">    _delegateFlags.didBeginWithPasscode = [delegate <span class="string">respondsToSelector:</span><span class="meta">@selector</span>(<span class="string">gestureLockView:</span><span class="string">didBeginWithPasscode:</span>)];</span><br><span class="line">    _delegateFlags.didEndWithPasscode = 。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用标记位判断是否实现协议方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (_delegateFlags.didBeginWithPasscode) &#123;</span><br><span class="line"></span><br><span class="line">     [self.delegate <span class="string">gestureLockView:</span>self <span class="string">didBeginWithPasscode:</span>[NSString <span class="string">stringWithFormat:</span>@<span class="string">"%zd"</span>,touchedButton.tag]];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-改进属性字符串">5.改进属性字符串</h3><p>在使用属性字符串的时候，不论生成还是对已知字符串进行某些字段设置属性，都是一件很麻烦的事情，要编写大段的样板代码实在是浪费时间。对生成配置属性字符串的操作进行简化，但是不要放弃系统提供的设置方法，因为系统的都会用，改进之后会好上手。</p>
<p>改进生成属性字符串的方式，简单需求比如一个个的拼接：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// black 16</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>) builder;</span><br><span class="line"><span class="comment">// &#123; NS...AttributeName : (id)value&#125;</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>) builderWithDefaultStyle:(<span class="built_in">NSDictionary</span> *)defaultStyle;</span><br><span class="line"></span><br><span class="line">- (HLLAttributedBuilder *) appendString:(<span class="built_in">NSString</span> *)string;</span><br><span class="line">- (HLLAttributedBuilder *(^)(<span class="built_in">NSString</span> *str)) appendString;</span><br><span class="line"></span><br><span class="line">- (HLLAttributedBuilder *) appendString:(<span class="built_in">NSString</span> *)string forStyle:(<span class="built_in">NSDictionary</span> *)style;</span><br><span class="line">- (HLLAttributedBuilder *(^)(<span class="built_in">NSString</span> *str ,<span class="built_in">NSDictionary</span> *style)) appendStringAndStyle;</span><br></pre></td></tr></table></figure>
<p>更常见的需求比如，查找特定的字符串然后进行属性设置。一种情形是，已有一个字符串，需要对其中的某一些字符串进行属性字符串设置，支持正则表达式匹配：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype) </span><span class="keyword">builderWithString:(NSString </span>*)<span class="keyword">originalString;</span></span><br><span class="line"><span class="keyword">+ </span>(<span class="keyword">instancetype) </span><span class="keyword">builderWithString:(NSString </span>*)<span class="keyword">originalString </span>defaultStyle:(NSDictionary *)defaultStyle<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">- (HLLAttributedBuilder *) configString:(NSString *)string forStyle:(NSDictionary *)style<span class="comment">;</span></span><br><span class="line">- (HLLAttributedBuilder *(^)(NSString *str ,NSDictionary *style)) configStringAndStyle<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>根据上面设置的属性然后调用<code>- (NSAttributedString *) attributedString;</code>方法就可以生成对应的属性字符串。</p>
<p>使用例子</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * display = <span class="string">@"hello = nihao = Hello = 你好 = nihao"</span>;</span><br><span class="line">attachment 是<span class="built_in">NSTextAttachment</span>类的实例</span><br><span class="line">[[[[[[[HLLAttributedBuilder builderWithString:display]</span><br><span class="line">                      configString:<span class="string">@"hello"</span> forStyle:@&#123;<span class="built_in">NSUnderlineColorAttributeName</span>:[<span class="built_in">UIColor</span> redColor],</span><br><span class="line">                                                       <span class="built_in">NSUnderlineStyleAttributeName</span>:@<span class="number">1</span>,</span><br><span class="line">                                                       <span class="built_in">NSForegroundColorAttributeName</span>:[<span class="built_in">UIColor</span> orangeColor]&#125;]</span><br><span class="line">                     configString:<span class="string">@"nihao"</span> forStyle:@&#123;<span class="built_in">NSStrokeColorAttributeName</span>:[<span class="built_in">UIColor</span> redColor],</span><br><span class="line">                                                      <span class="built_in">NSStrokeWidthAttributeName</span>:@<span class="number">1</span>&#125;]</span><br><span class="line">                    configString:<span class="string">@"H"</span> forStyle:@&#123;<span class="built_in">NSBackgroundColorAttributeName</span>:[<span class="built_in">UIColor</span> greenColor]&#125;]</span><br><span class="line">                   appendAttachment:attachment]</span><br><span class="line">                  appendString:<span class="string">@"娃大喜"</span>]</span><br><span class="line">                 attributedString];</span><br></pre></td></tr></table></figure>
<p>内部主要是使用私有类来记录每次的属性设置，用<strong>attributedString</strong>属性来记录，然后使用数组来保存这个私有实例。对于<code>-append...</code>方式，每次将记录的对象放入数组，而对于<code>-configString...</code>方式，则是数组中一直只有一个对象。</p>
<h3 id="6-简化NSUserDefaults的使用">6.简化NSUserDefaults的使用</h3><p>NSUserDefaults一般用来保存一些简单的数据到本地，但是写起来会写很多的样板代码，没有什么技术含量，稍微不注意还会出错，这里将NSUserDefaults添加一个分类，简化他的使用。</p>
<p>结合宏和block的特性，可以很优雅的使用点语法调用。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define MM_UserDefaults [NSUserDefaults standardUserDefaults]</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSUserDefaults</span> (<span class="title">MM_Tools</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUserDefaults</span> *(^)(<span class="built_in">NSString</span> *key,<span class="built_in">BOOL</span> value))mm_addBool;</span><br><span class="line">- (<span class="built_in">BOOL</span>(^)(<span class="built_in">NSString</span> *))mm_boolValue;</span><br><span class="line">...</span><br><span class="line">- (<span class="built_in">NSUserDefaults</span> *(^)(<span class="built_in">NSString</span> *key,<span class="keyword">id</span> value))mm_addObject;</span><br><span class="line">- (<span class="keyword">id</span>(^)(<span class="built_in">NSString</span> *))mm_objectValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>对应的实现</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSUserDefaults</span> *(^)(<span class="built_in">NSString</span> *,<span class="built_in">BOOL</span>))mm_addBool&#123;</span><br><span class="line">    <span class="keyword">return</span> ^<span class="built_in">NSUserDefaults</span> *(<span class="built_in">NSString</span> *key,<span class="built_in">BOOL</span> value)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.mm_addObject(key,@(value));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>(^)(<span class="built_in">NSString</span> *))mm_boolValue&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *key)&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.mm_objectValue(key) boolValue];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">- (<span class="built_in">NSUserDefaults</span> *(^)(<span class="built_in">NSString</span> *,<span class="keyword">id</span>))mm_addObject&#123;</span><br><span class="line">    <span class="keyword">return</span> ^<span class="built_in">NSUserDefaults</span> *(<span class="built_in">NSString</span> *key,<span class="keyword">id</span> value)&#123;</span><br><span class="line">        [<span class="keyword">self</span> setValue:value forKey:key];</span><br><span class="line">        [<span class="keyword">self</span> synchronize];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">id</span>(^)(<span class="built_in">NSString</span> *))mm_objectValue&#123;</span><br><span class="line">    <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="built_in">NSString</span> *key)&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> valueForKey:key];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用的时候可以这样</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MM_UserDefaults</span><span class="selector-class">.mm_addBool</span>(@"<span class="keyword">some_bool_key</span>",<span class="keyword">YES</span>);</span><br><span class="line"><span class="selector-tag">MM_UserDefaults</span><span class="selector-class">.mm_boolValue</span>(@"<span class="keyword">some_bool_key</span>");</span><br></pre></td></tr></table></figure>
<h3 id="7-优雅的为分类添加属性">7.优雅的为分类添加属性</h3><p>难保会遇到要在某一个分类中添加好多的属性，结合runtime可以实现，但是要写好多的重复代码，对于这些重复代码，使用宏来统一替换是一个很好的方法。</p>
<p>借由下面文章中的方法，实现为一个单例添加一些属性，结合上面的<code>MM_UserDefaults</code>对这些属性进行本地存储</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> MM_Manager (UserDefaults)</span><br><span class="line"></span><br><span class="line">mm_property_basicDataType(BOOL, openDebugerToggle</span><br><span class="line">...</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> MM_Manager (UserDefaults)</span><br><span class="line">                          </span><br><span class="line">mm_def_property_basicDataType(BOOL, openDebugerToggle)</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>宏里面有两个对当前类的方法需要添加</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MM_Manager</span> (<span class="title">MM_associated</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)mm_getAssociatedObjectForKey:(<span class="keyword">const</span> <span class="keyword">char</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * propName = key;</span><br><span class="line">    <span class="built_in">NSString</span> * key_ = [<span class="built_in">NSString</span> stringWithUTF8String:propName];</span><br><span class="line">    <span class="keyword">return</span> MM_UserDefaults.mm_objectValue(key_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)mm_setAssignAssociatedObject:(<span class="keyword">id</span>)obj forKey:(<span class="keyword">const</span> <span class="keyword">char</span> *)key;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * propName = key;</span><br><span class="line">    <span class="built_in">NSString</span> * key_ = [<span class="built_in">NSString</span> stringWithUTF8String:propName];</span><br><span class="line">    <span class="keyword">id</span> oldValue = MM_UserDefaults.mm_objectValue(key_);</span><br><span class="line">    MM_UserDefaults.mm_addObject(key_ ,obj);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"userdefault:%@ for key:%@"</span>,obj,key_);</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>要了解如何使用宏，请参考👇的文章</p>
<p><a href="http://blog.csdn.net/uxyheaven/article/details/46789065" target="_blank" rel="noopener">为分类添加试用宏添加属性</a></p>
<p><a href="http://www.jianshu.com/p/4c5613e256c8" target="_blank" rel="noopener">对ReactiveCocoa中宏的解释</a></p>
<h3 id="8-合理的修改readonly属性以及便捷的进行copy操作">8.合理的修改readonly属性以及便捷的进行copy操作</h3><p>一个场景是一个类通过一个参数初始化，然后他也有一个属性和这个参数一样，但是<strong>是readonly</strong>的，</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Reminder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *title;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWith:(<span class="built_in">NSString</span> *)title;</span><br><span class="line"></span><br><span class="line">@impeletation</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTitle:(<span class="built_in">NSString</span> *)title </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">    _title = title;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就没有办法修改这个<code>title</code>属性了，虽然可以通过KVC，但是，想象一下有很多参数的时候，那就是比较麻烦的事情了。具体还有其他什么麻烦的情况，可以<a href="http://holko.pl/2015/05/12/immutable-object-initialization/" target="_blank" rel="noopener">参考这个博文</a>，里面也有应对麻烦场景下的解决办法，这些办法都不是很优雅，最后通过runtime特性做出了一个小巧的工具。</p>
<p>里面主要用到了<code>runtime</code>来获取类的所有属性、消息传递、<code>KVC</code>来对所有的属性进行赋值，主要涉及到两个方法</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(NSMethodSignature *)</span>methodSignatureForSelector:<span class="params">(SEL)</span>sel;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>forwardInvocation:<span class="params">(NSInvocation *)</span>invocation;</span><br></pre></td></tr></table></figure>
<p>具体<code>NSInvocation</code>的用法，一搜一大堆，这不是重点，根据以上两个方法可以将target对象进行KVC设置readonly属性，最后的工具方法有两个：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">AHKBuilder</span>)</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBuilder_ahk:(<span class="keyword">void</span> (^)(<span class="keyword">id</span>))builderBlock;</span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithBuilder_ahk:(<span class="keyword">void</span> (^)(<span class="keyword">id</span>))builderBlock;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>有两种使用方法，第一种就是为readonly属性设置值</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">MM_testObjBuilder</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">retain</span> ,<span class="keyword">readwrite</span>) <span class="built_in">NSString</span> * title;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MM_testObj</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">copy</span>) <span class="built_in">NSString</span> * detail;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">retain</span> ,<span class="keyword">readonly</span>) <span class="built_in">NSString</span> * title;</span><br><span class="line">- (<span class="keyword">instancetype</span>) initWith:(<span class="built_in">NSString</span> *)title;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">MM_testObj * obj = [[MM_testObj alloc] initWith:<span class="string">@"Name"</span>];</span><br><span class="line">obj.detail = <span class="string">@"Detail"</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@/%@"</span>,obj.title,obj.detail);<span class="comment">// Name/Detail</span></span><br><span class="line"></span><br><span class="line">MM_testObj * obj_1 = [[MM_testObj alloc] initWithBuilder_ahk:^(<span class="keyword">id</span>&lt;MM_testObjBuilder&gt;builder) &#123;</span><br><span class="line">    builder.title = <span class="string">@"Name_1"</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@/%@"</span>,obj_1.title,obj_1.detail);<span class="comment">// Name_1/(null)</span></span><br></pre></td></tr></table></figure>
<p>第二种是对一个已有对象进行拷贝，说是拷贝，其实就是挨个对属性进行赋值，所以也就不需要被拷贝的类遵守<code>NSCopying</code>协议</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MM_testObj * obj_2 = [obj copyWithBuilder_ahk:^(id&lt;MM_testObjBuilder&gt;<span class="keyword">builder) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;]<span class="comment">;</span></span><br><span class="line">NSLog(@<span class="string">"%@/%@"</span>,obj_2.title,obj_2.detail)<span class="comment">;// Name/Detail</span></span><br><span class="line"></span><br><span class="line">MM_testObj * obj_3 = [obj copyWithBuilder_ahk:^(id&lt;MM_testObjBuilder&gt;<span class="keyword">builder) </span>&#123;</span><br><span class="line">    <span class="keyword">builder.title </span>= @<span class="string">"Name_3"</span><span class="comment">;</span></span><br><span class="line">&#125;]<span class="comment">;</span></span><br><span class="line">NSLog(@<span class="string">"%@/%@"</span>,obj_3.title,obj_3.detail)<span class="comment">;// Name_3/Detail</span></span><br></pre></td></tr></table></figure>
<p>在正常开发中是不太会用到这种操作的，只不过是对<strong>Builder模式</strong>和<strong>runtime</strong>、<strong>NSInvocation</strong>的一个小练习。当然，如果在逆向的时候需要hook一些类，那就是很实用的工具了。</p>
<p><a href="http://holko.pl/2015/05/12/immutable-object-initialization/" target="_blank" rel="noopener">参考文章</a></p>
<p><a href="https://github.com/fastred/AHKBuilder" target="_blank" rel="noopener">仓库地址</a></p>
<hr>
<p>Continue update …</p>
</div><div class="post-tags-box"><a class="tag-link" href="/tags/学习/">学习</a></div></article></div><div class="post-nav"><div class="prev-wrap col-md-6 col-xs-6"><i class="fa fa-angle-double-left"></i><a href="/2017/08/05/sketch/" class="prev-post">使用Sketch进行设计学习</a></div><div class="next-wrap col-md-6 col-xs-6"><a href="/2016/12/11/one-function/" class="next-post">一个bug了解JS的核心知识点</a><i class="fa fa-angle-double-right"></i></div></div></main></div><footer><div class="copyright"><p>Crafted with <i class="fa fa-heart"></i> by&nbsp;Yrocky&nbsp;|&nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yiliashaw/hexo-theme-prince" target="_blank">Prince</a> by SHAW</p></div></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.0.47/jquery.fancybox.min.js"></script><script src="/js/script.js"></script></body></html>